-- Doodle World Auto Encounter - Based on Working Scripts
print("Loading Auto Farm...")

-- Wait for game
repeat task.wait() until game:IsLoaded()

-- Services
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local Player = Players.LocalPlayer
if not Player then
    Players:GetPropertyChangedSignal("LocalPlayer"):Wait()
    Player = Players.LocalPlayer
end

print("Player found:", Player.Name)

-- Wait for Remotes
local Remotes = Player:WaitForChild("Remotes", 30)
if not Remotes then
    warn("‚ùå Remotes not found!")
    return
end
print("‚úì Remotes found")

-- Get remotes
local DudeWhyld = Remotes:WaitForChild("DudeWhyld", 10)
local StartBattle = Remotes:WaitForChild("StartBattle", 10)
local BattleAction = Remotes:WaitForChild("BattleAction", 10)

if not DudeWhyld then
    warn("‚ùå DudeWhyld not found!")
    return
end
print("‚úì DudeWhyld found")

if not StartBattle then
    warn("‚ùå StartBattle not found!")
    return
end
print("‚úì StartBattle found")

if not BattleAction then
    warn("‚ùå BattleAction not found!")
    return
end
print("‚úì BattleAction found")

-- Get Client
local Client = Player:WaitForChild("Client", 30)
if not Client then
    warn("‚ùå Client not found!")
    return
end

local ClientModule = require(Client)
print("‚úì Client module loaded")

-- Get Database
local Database = nil
local ClientRunner = Player:FindFirstChild("ClientRunner")

if ClientRunner then
    Database = ClientRunner:FindFirstChild("Database")
    if Database then
        print("‚úì Database found in ClientRunner")
    end
end

if not Database and Client then
    Database = Client:FindFirstChild("ClientDatabase") or Client:FindFirstChild("Database")
    if Database then
        print("‚úì Database found in Client")
    end
end

if not Database then
    warn("‚ùå Database not found!")
    return
end

-- Load DoodleInfo
local DoodleInfo = nil
local DoodleInfoModule = Database:FindFirstChild("DoodleInfo")
if DoodleInfoModule then
    local success, err = pcall(function()
        DoodleInfo = require(DoodleInfoModule)
    end)
    
    if success then
        print("‚úì DoodleInfo loaded")
    else
        warn("‚ùå Failed to load DoodleInfo:", err)
        return
    end
else
    warn("‚ùå DoodleInfo module not found!")
    return
end

-- Build Doodle list
local DoodleNames = {}
if DoodleInfo then
    for name, _ in pairs(DoodleInfo) do
        table.insert(DoodleNames, name)
    end
    table.sort(DoodleNames)
    print("‚úì Loaded", #DoodleNames, "Doodles")
end

-- Zone Map
local zoneEncounters = {
    ["025_Sweetsville"] = "WildGrass",
    ["033_Academy"] = "WildGrass",
    ["029_SubwayStation"] = "WildGrass",
    ["TheCarnival"] = "WildGrass",
    ["Route_1"] = "WildGrass",
    ["006_Route2"] = "WildGrass",
    ["007_Lakewood"] = "WildGrass",
    ["011_Sewer"] = "WildGrass",
    ["010_Route3"] = "WildGrass",
    ["013_Route4"] = "WildGrass",
    ["014_GraphiteLodge"] = "WildGrass",
    ["017_Crossroads"] = "WildGrass",
    ["018_CrystalCaverns"] = "WildGrass",
    ["020_GraphiteForest"] = "WildGrass",
    ["022_ForestMaze"] = "WildGrass",
    ["024_Route5"] = "WildGrass",
    ["028_PirateCabin"] = "WildGrass",
    ["031_CandyFactory"] = "WildGrass"
}

-- Settings
local Settings = {
    Enabled = false,
    TargetSpecies = "",
    MinStars = 1,
    OnlyMisprint = false,
    OnlyHiddenTrait = false,
    ChainMode = false,
    SelectedMoveSlot = 1,
    EncounterDelay = 2
}

local Stats = {
    Encounters = 0,
    Chain = 0,
    Found = 0
}

-- Helper Functions
local function GetBattleData()
    local battleData = nil
    
    pcall(function()
        if ClientModule.Battle and ClientModule.Battle.CurrentBattle then
            battleData = ClientModule.Battle.CurrentBattle
        end
    end)
    
    return battleData
end

local function GetOutDoodle()
    local battleData = GetBattleData()
    if not battleData then return nil end
    
    local success, result = pcall(function()
        local Party = battleData["Player1Party"]
        if Party and Party[1] then
            return Party[1]
        end
        return nil
    end)
    
    if success then
        return result
    end
    return nil
end

local function CheckMatch(wildDoodle)
    if not wildDoodle then return false, "No Doodle" end
    
    -- Check species
    if Settings.TargetSpecies ~= "" then
        local name = (wildDoodle.Name or wildDoodle.RealName or ""):lower()
        local target = Settings.TargetSpecies:lower()
        if not name:find(target, 1, true) then
            return false, "Wrong Species"
        end
    end
    
    -- Check stars
    local stars = wildDoodle.Star or 0
    if stars < Settings.MinStars then
        return false, "Low Stars (" .. stars .. "/" .. Settings.MinStars .. ")"
    end
    
    -- Check misprint
    if Settings.OnlyMisprint then
        local isMisprint = wildDoodle.Shiny or (wildDoodle.Color and wildDoodle.Color ~= "Normal")
        if not isMisprint then
            return false, "Not Misprint"
        end
    end
    
    -- Check hidden trait
    if Settings.OnlyHiddenTrait then
        if not wildDoodle.HiddenTrait then
            return false, "No Hidden Trait"
        end
    end
    
    return true, "Match Found!"
end

local function EndTurn()
    pcall(function()
        if getupvalues and ClientModule.Network and ClientModule.Network.BindEvent then
            local UpValues = getupvalues(ClientModule.Network.BindEvent)
            for i, v in pairs(UpValues) do
                if typeof(v) == "table" and v["ForceEnd"] ~= nil then
                    v.ForceEnd()
                    break
                end
            end
        end
    end)
end

local function PerformBattleAction(myDoodle, enemyDoodle, shouldRun)
    if not myDoodle then return end
    
    task.wait(0.5)
    
    pcall(function()
        if shouldRun then
            -- Run away
            ClientModule.Network:post("BattleAction", {
                [1] = {
                    ["Target"] = "RunAway",
                    ["ActionType"] = "Run",
                    ["User"] = myDoodle.ID,
                }
            })
        else
            -- Attack with selected move
            if myDoodle.Moves and myDoodle.Moves[Settings.SelectedMoveSlot] then
                local moveName = myDoodle.Moves[Settings.SelectedMoveSlot].Name
                
                ClientModule.Network:post("BattleAction", {
                    [1] = {
                        ["Target"] = enemyDoodle and enemyDoodle.ID or myDoodle.ID,
                        ["ActionType"] = "Attack",
                        ["Action"] = moveName,
                        ["User"] = myDoodle.ID,
                    }
                })
            end
        end
        
        EndTurn()
    end)
end

-- Battle Event Handler
StartBattle.OnClientEvent:Connect(function(battleData)
    if not Settings.Enabled then return end
    
    local wildDoodle = battleData.Player2Party and battleData.Player2Party[1]
    local myDoodle = battleData.Player1Party and battleData.Player1Party[1]
    
    if wildDoodle and myDoodle then
        Stats.Encounters = Stats.Encounters + 1
        
        local name = wildDoodle.Name or wildDoodle.RealName or "Unknown"
        local stars = wildDoodle.Star or 0
        local isMisprint = wildDoodle.Shiny or (wildDoodle.Color and wildDoodle.Color ~= "Normal")
        
        print(string.format("Encounter #%d: %s (%d‚≠ê) %s", 
            Stats.Encounters, 
            name, 
            stars,
            isMisprint and "[MISPRINT]" or ""
        ))
        
        -- Check if matches filters
        local isMatch, reason = CheckMatch(wildDoodle)
        
        if isMatch then
            print("‚úÖ MATCH FOUND:", reason)
            Stats.Found = Stats.Found + 1
            
            if not Settings.ChainMode then
                Settings.Enabled = false
                print("üéâ Target found! Stopping farm.")
            else
                Stats.Chain = Stats.Chain + 1
                print("Chain:", Stats.Chain)
            end
            
            -- Don't run, let player catch
            return
        else
            print("‚ùå No match:", reason)
            
            if Settings.ChainMode then
                -- Check if same species
                local isSameSpecies = false
                if Settings.TargetSpecies ~= "" then
                    local wildName = (wildDoodle.Name or wildDoodle.RealName or ""):lower()
                    isSameSpecies = wildName:find(Settings.TargetSpecies:lower(), 1, true) ~= nil
                end
                
                if isSameSpecies then
                    -- Same species but wrong stats - kill it
                    PerformBattleAction(myDoodle, wildDoodle, false)
                else
                    -- Different species - run
                    PerformBattleAction(myDoodle, wildDoodle, true)
                end
            else
                -- Not chaining - just run
                PerformBattleAction(myDoodle, wildDoodle, true)
            end
        end
    end
end)

-- Create GUI
print("Creating GUI...")

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "DoodleAutoFarmGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 350, 0, 550)
MainFrame.Position = UDim2.new(0.5, -175, 0.5, -275)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui

local MainCorner = Instance.new("UICorner")
MainCorner.CornerRadius = UDim.new(0, 10)
MainCorner.Parent = MainFrame

-- Title Bar
local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 40)
TitleBar.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
TitleBar.BorderSizePixel = 0
TitleBar.Parent = MainFrame

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 10)
TitleCorner.Parent = TitleBar

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Size = UDim2.new(1, -50, 1, 0)
TitleLabel.Position = UDim2.new(0, 10, 0, 0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text = "üéÆ Doodle Auto Farm"
TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleLabel.TextSize = 16
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.Parent = TitleBar

local CloseBtn = Instance.new("TextButton")
CloseBtn.Size = UDim2.new(0, 30, 0, 30)
CloseBtn.Position = UDim2.new(1, -35, 0, 5)
CloseBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
CloseBtn.Text = "X"
CloseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseBtn.TextSize = 14
CloseBtn.Font = Enum.Font.GothamBold
CloseBtn.Parent = TitleBar

local CloseCorner = Instance.new("UICorner")
CloseCorner.CornerRadius = UDim.new(0, 6)
CloseCorner.Parent = CloseBtn

CloseBtn.MouseButton1Click:Connect(function()
    Settings.Enabled = false
    ScreenGui:Destroy()
end)

-- Content
local Content = Instance.new("ScrollingFrame")
Content.Size = UDim2.new(1, -20, 1, -60)
Content.Position = UDim2.new(0, 10, 0, 50)
Content.BackgroundTransparency = 1
Content.BorderSizePixel = 0
Content.ScrollBarThickness = 6
Content.Parent = MainFrame

local Layout = Instance.new("UIListLayout")
Layout.Padding = UDim.new(0, 10)
Layout.SortOrder = Enum.SortOrder.LayoutOrder
Layout.Parent = Content

-- Section Helper
local function AddSection(text)
    local section = Instance.new("TextLabel")
    section.Size = UDim2.new(1, 0, 0, 25)
    section.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
    section.Text = text
    section.TextColor3 = Color3.fromRGB(200, 200, 200)
    section.TextSize = 13
    section.Font = Enum.Font.GothamBold
    section.Parent = Content
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = section
    
    return section
end

-- Toggle Helper
local function AddToggle(text, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 35)
    frame.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
    frame.BorderSizePixel = 0
    frame.Parent = Content
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = frame
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -80, 1, 0)
    label.Position = UDim2.new(0, 10, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 13
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame
    
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 60, 0, 25)
    btn.Position = UDim2.new(1, -70, 0.5, -12.5)
    btn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    btn.Text = "OFF"
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.TextSize = 12
    btn.Font = Enum.Font.GothamBold
    btn.Parent = frame
    
    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 6)
    btnCorner.Parent = btn
    
    local toggled = false
    btn.MouseButton1Click:Connect(function()
        toggled = not toggled
        btn.BackgroundColor3 = toggled and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(200, 50, 50)
        btn.Text = toggled and "ON" or "OFF"
        callback(toggled)
    end)
    
    return btn
end

-- TextBox Helper
local function AddTextBox(placeholder, callback)
    local box = Instance.new("TextBox")
    box.Size = UDim2.new(1, 0, 0, 35)
    box.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
    box.Text = ""
    box.PlaceholderText = placeholder
    box.TextColor3 = Color3.fromRGB(255, 255, 255)
    box.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
    box.TextSize = 13
    box.Font = Enum.Font.Gotham
    box.ClearTextOnFocus = false
    box.Parent = Content
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = box
    
    box.FocusLost:Connect(function()
        callback(box.Text)
    end)
    
    return box
end

-- Slider Helper
local function AddSlider(text, min, max, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 50)
    frame.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
    frame.BorderSizePixel = 0
    frame.Parent = Content
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = frame
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -80, 0, 20)
    label.Position = UDim2.new(0, 10, 0, 5)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 13
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame
    
    local valueLabel = Instance.new("TextLabel")
    valueLabel.Size = UDim2.new(0, 60, 0, 20)
    valueLabel.Position = UDim2.new(1, -70, 0, 5)
    valueLabel.BackgroundTransparency = 1
    valueLabel.Text = tostring(min)
    valueLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    valueLabel.TextSize = 13
    valueLabel.Font = Enum.Font.GothamBold
    valueLabel.Parent = frame
    
    local bar = Instance.new("Frame")
    bar.Size = UDim2.new(1, -20, 0, 6)
    bar.Position = UDim2.new(0, 10, 1, -15)
    bar.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
    bar.BorderSizePixel = 0
    bar.Parent = frame
    
    local barCorner = Instance.new("UICorner")
    barCorner.CornerRadius = UDim.new(0, 3)
    barCorner.Parent = bar
    
    local fill = Instance.new("Frame")
    fill.Size = UDim2.new(0, 0, 1, 0)
    fill.BackgroundColor3 = Color3.fromRGB(75, 150, 255)
    fill.BorderSizePixel = 0
    fill.Parent = bar
    
    local fillCorner = Instance.new("UICorner")
    fillCorner.CornerRadius = UDim.new(0, 3)
    fillCorner.Parent = fill
    
    local value = min
    
    local function update(input)
        local pos = math.clamp((input.Position.X - bar.AbsolutePosition.X) / bar.AbsoluteSize.X, 0, 1)
        value = math.floor(min + (max - min) * pos)
        valueLabel.Text = tostring(value)
        fill.Size = UDim2.new(pos, 0, 1, 0)
        callback(value)
    end
    
    local dragging = false
    bar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            update(input)
        end
    end)
    
    bar.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            update(input)
        end
    end)
end

-- Build GUI
AddSection("‚öôÔ∏è Main Controls")

AddToggle("Start Farming", function(value)
    Settings.Enabled = value
    print("Farming:", value and "enabled" or "disabled")
    if value then
        Stats.Encounters = 0
        Stats.Chain = 0
    end
end)

AddSection("üéØ Filters")

AddTextBox("Target Species (leave empty for any)", function(text)
    Settings.TargetSpecies = text
    print("Target:", text == "" and "Any" or text)
end)

AddSlider("Minimum Stars", 1, 6, function(value)
    Settings.MinStars = value
end)

AddToggle("Only Misprint", function(value)
    Settings.OnlyMisprint = value
end)

AddToggle("Only Hidden Trait", function(value)
    Settings.OnlyHiddenTrait = value
end)

AddSection("‚öîÔ∏è Battle Settings")

AddToggle("Chain Mode (Kill/Run)", function(value)
    Settings.ChainMode = value
end)

AddSlider("Move Slot", 1, 4, function(value)
    Settings.SelectedMoveSlot = value
end)

AddSection("üìä Stats")

local statsLabel = Instance.new("TextLabel")
statsLabel.Size = UDim2.new(1, 0, 0, 60)
statsLabel.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
statsLabel.BorderSizePixel = 0
statsLabel.Text = "Encounters: 0\nChain: 0\nFound: 0"
statsLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
statsLabel.TextSize = 13
statsLabel.Font = Enum.Font.GothamBold
statsLabel.Parent = Content

local statsCorner = Instance.new("UICorner")
statsCorner.CornerRadius = UDim.new(0, 6)
statsCorner.Parent = statsLabel

-- Update stats
task.spawn(function()
    while task.wait(1) do
        statsLabel.Text = string.format("Encounters: %d\nChain: %d\nFound: %d", 
            Stats.Encounters, Stats.Chain, Stats.Found)
    end
end)

-- Make draggable
local dragging, dragInput, dragStart, startPos

TitleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

TitleBar.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

Layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    Content.CanvasSize = UDim2.new(0, 0, 0, Layout.AbsoluteContentSize.Y + 10)
end)

-- Parent GUI
ScreenGui.Parent = Player:WaitForChild("PlayerGui")

print("‚úì GUI created")

-- Encounter Loop
task.spawn(function()
    print("‚úì Encounter loop started")
    while task.wait(1) do
        if Settings.Enabled then
            local char = Player.Character
            if char and char:FindFirstChild("HumanoidRootPart") then
                local zone = nil
                for _, obj in ipairs(Workspace:GetChildren()) do
                    if obj.Name:match("^%d%d%d_") or zoneEncounters[obj.Name] then
                        zone = obj.Name
                        break
                    end
                end
                
                if zone and zoneEncounters[zone] then
                    pcall(function()
                        DudeWhyld:FireServer(zone, zoneEncounters[zone])
                    end)
                end
            end
            task.wait(Settings.EncounterDelay)
        end
    end
end)

-- Disable idle kick
pcall(function()
    if getconnections then
        for _, connection in pairs(getconnections(Player.Idled)) do
            connection:Disable()
        end
    end
end)

print("‚úÖ Auto Farm Loaded!")
print("Walk around grass to trigger encounters!")
