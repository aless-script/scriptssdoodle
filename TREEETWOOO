-- Doodle World Auto Encounter - COMPLETE FIXED VERSION
print("Loading Auto Farm...")

-- Wait for game
repeat task.wait() until game:IsLoaded()

if game.GameId == 0 then
    game:GetPropertyChangedSignal("GameId"):Wait()
end

-- Services
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local Player = Players.LocalPlayer
if not Player then
    Players:GetPropertyChangedSignal("LocalPlayer"):Wait()
    Player = Players.LocalPlayer
end

print("Player found:", Player.Name)

-- Wait for Remotes
local Remotes = Player:WaitForChild("Remotes", 30)
if not Remotes then
    warn("‚ùå Remotes not found!")
    return
end
print("‚úì Remotes found")

-- Get remotes
local DudeWhyld = Remotes:WaitForChild("DudeWhyld", 10)
local BattleAction = Remotes:WaitForChild("BattleAction", 10)

if not DudeWhyld then
    warn("‚ùå DudeWhyld not found!")
    return
end
print("‚úì DudeWhyld found")

if not BattleAction then
    warn("‚ùå BattleAction not found!")
    return
end
print("‚úì BattleAction found")

-- Get Client
local Client = Player:WaitForChild("Client", 30)
if not Client then
    warn("‚ùå Client not found!")
    return
end

local ClientModule = require(Client)
print("‚úì Client module loaded")

-- Get Database
local Database = nil
local ClientRunner = Player:FindFirstChild("ClientRunner")

if ClientRunner then
    Database = ClientRunner:FindFirstChild("Database")
    if Database then
        print("‚úì Database found in ClientRunner")
    end
end

if not Database and Client then
    Database = Client:FindFirstChild("ClientDatabase") or Client:FindFirstChild("Database")
    if Database then
        print("‚úì Database found in Client")
    end
end

if not Database then
    warn("‚ùå Database not found!")
    return
end

-- Load DoodleInfo
local DoodleInfo = nil
local DoodleInfoModule = Database:FindFirstChild("DoodleInfo")
if DoodleInfoModule then
    local success, err = pcall(function()
        DoodleInfo = require(DoodleInfoModule)
    end)
    
    if success then
        print("‚úì DoodleInfo loaded")
    else
        warn("‚ùå Failed to load DoodleInfo:", err)
        return
    end
else
    warn("‚ùå DoodleInfo module not found!")
    return
end

-- Build Doodle list
local DoodleNames = {}
if DoodleInfo then
    for name, _ in pairs(DoodleInfo) do
        table.insert(DoodleNames, name)
    end
    table.sort(DoodleNames)
    print("‚úì Loaded", #DoodleNames, "Doodles")
end

-- Zone Map
local zoneEncounters = {
    ["025_Sweetsville"] = "WildGrass",
    ["033_Academy"] = "WildGrass",
    ["029_SubwayStation"] = "WildGrass",
    ["TheCarnival"] = "WildGrass",
    ["Route_1"] = "WildGrass",
    ["006_Route2"] = "WildGrass",
    ["007_Lakewood"] = "WildGrass",
    ["008_LakewoodSewers"] = "WildGrass",
    ["011_Sewer"] = "WildGrass",
    ["010_Route3"] = "WildGrass",
    ["013_Route4"] = "WildGrass",
    ["014_GraphiteLodge"] = "WildGrass",
    ["015_GraphiteLodgePath"] = "WildGrass",
    ["017_Crossroads"] = "WildGrass",
    ["018_CrystalCaverns"] = "WildGrass",
    ["020_GraphiteForest"] = "WildGrass",
    ["022_ForestMaze"] = "WildGrass",
    ["024_Route5"] = "WildGrass",
    ["026_VonSweetenManor"] = "WildGrass",
    ["028_PirateCabin"] = "WildGrass",
    ["031_CandyFactory"] = "WildGrass"
}

-- Settings
local Settings = {
    Enabled = false,
    TargetSpecies = "",
    OnlyMisprint = false,
    OnlyHiddenTrait = false,
    TargetAbility = "",
    TargetGender = "Any",
    TargetSkin = "Any",
    ChainMode = false,
    SelectedMoveSlot = 1,
    EncounterDelay = 2,
    HealLocation = "Academy"
}

local Stats = {
    Encounters = 0,
    Chain = 0,
    Found = 0
}

-- Helper Functions
local function GetBattleData()
    local battleData = nil
    
    pcall(function()
        if ClientModule.Battle and ClientModule.Battle.CurrentBattle then
            battleData = ClientModule.Battle.CurrentBattle
        end
    end)
    
    return battleData
end

local function GetOutDoodle()
    local battleData = GetBattleData()
    if not battleData then return nil end
    
    local success, result = pcall(function()
        local MainGui = Player.PlayerGui:FindFirstChild("MainGui")
        if not MainGui then return nil end
        
        local BattleGui = MainGui:FindFirstChild("MainBattle")
        if not BattleGui then return nil end
        
        local InfoHolder = BattleGui:FindFirstChild("BackBox")
        if not InfoHolder then return nil end
        
        local NameLabel = InfoHolder:FindFirstChild("NameLabel")
        local LevelLabel = InfoHolder:FindFirstChild("LevelLabel")
        local Health = InfoHolder:FindFirstChild("Health")
        if not NameLabel or not LevelLabel or not Health then return nil end
        
        local HealthLabel = Health:FindFirstChild("HealthNumber")
        if not HealthLabel then return nil end
        
        local Party = battleData["Player1Party"]
        if not Party then return nil end
        
        local MaxHealth = string.split(HealthLabel.Text,"/")
        MaxHealth = string.gsub(MaxHealth[2]," ","")
        MaxHealth = tonumber(MaxHealth)
        local Level = string.gsub(LevelLabel.Text,"Lv. ","")
        Level = tonumber(Level)
        
        for i,v in pairs(Party) do
            if v.Stats and v.Stats.hp == MaxHealth then
                if v.Name == NameLabel.Text or (v.Doodle and v.Doodle.Nickname == NameLabel.Text) then
                    if v.Level == Level then
                        return v
                    end
                end
            end
        end
        
        for i,v in pairs(Party) do
            if v.Name == NameLabel.Text or (v.Doodle and v.Doodle.Nickname == NameLabel.Text) then
                return v
            end
        end
        
        return Party[1]
    end)
    
    if success then
        return result
    end
    return nil
end

local function GetEnemyDoodle()
    local battleData = GetBattleData()
    if not battleData then return nil end
    
    local success, result = pcall(function()
        if battleData["Player2Party"] and battleData["Player2Party"][1] then
            return battleData["Player2Party"][1]
        end
        return nil
    end)
    
    if success and result then
        return result
    end
    return nil
end

local function CheckMatch(wildDoodle)
    if not wildDoodle then return false, "No Doodle" end
    
    local failReasons = {}
    
    -- Check species
    if Settings.TargetSpecies ~= "" then
        local name = (wildDoodle.Name or wildDoodle.RealName or ""):lower()
        local target = Settings.TargetSpecies:lower()
        if not name:find(target, 1, true) then
            table.insert(failReasons, "Wrong Species")
        end
    end
    
    -- Check misprint
    if Settings.OnlyMisprint then
        local isMisprint = wildDoodle.Shiny or (wildDoodle.Color and wildDoodle.Color ~= "Normal")
        if not isMisprint then
            table.insert(failReasons, "Not Misprint")
        end
    end
    
    -- Check hidden trait
    if Settings.OnlyHiddenTrait then
        if not wildDoodle.HiddenTrait then
            table.insert(failReasons, "No Hidden Trait")
        end
    end
    
    -- Check specific ability
    if Settings.TargetAbility ~= "" then
        local ability = wildDoodle.Ability or wildDoodle.AbilityName or ""
        local targetAbility = Settings.TargetAbility:lower()
        if ability:lower() ~= targetAbility then
            table.insert(failReasons, "Wrong Ability (" .. ability .. ")")
        end
    end
    
    -- Check gender
    if Settings.TargetGender ~= "Any" then
        local gender = wildDoodle.Gender or "Unknown"
        if gender ~= Settings.TargetGender then
            table.insert(failReasons, "Wrong Gender (" .. gender .. ")")
        end
    end
    
    -- Check skin
    if Settings.TargetSkin ~= "Any" then
        local skin = wildDoodle.Skin or wildDoodle.SkinName or "Default"
        if Settings.TargetSkin == "Default" then
            if skin ~= "Default" and skin ~= "" then
                table.insert(failReasons, "Has Skin (" .. skin .. ")")
            end
        elseif Settings.TargetSkin == "HasSkin" then
            if skin == "Default" or skin == "" then
                table.insert(failReasons, "No Skin")
            end
        else
            local targetSkin = Settings.TargetSkin:lower()
            if skin:lower() ~= targetSkin then
                table.insert(failReasons, "Wrong Skin (" .. skin .. ")")
            end
        end
    end
    
    -- ALL conditions must pass
    if #failReasons > 0 then
        return false, table.concat(failReasons, ", ")
    end
    
    return true, "‚úÖ ALL CONDITIONS MET!"
end

local function EndTurn()
    pcall(function()
        if getupvalues then
            local UpValues = getupvalues(ClientModule.Network.BindEvent)
            for i,v in pairs(UpValues) do
                if typeof(v) == "table" and v["ForceEnd"] ~= nil then
                    v.ForceEnd()
                    break
                end
            end
        end
    end)
end

local function HealTeam()
    pcall(function()
        print("üíö Healing team at " .. Settings.HealLocation .. "...")
        local args = {
            "Heal",
            Settings.HealLocation
        }
        Player:WaitForChild("Remotes"):WaitForChild("PlayerDataEvent"):FireServer(unpack(args))
        task.wait(1)
        print("‚úì Team healed!")
    end)
end

-- Auto Battle Loop
local lastEncounterID = nil

task.spawn(function()
    print("‚úì Auto Battle Loop started")
    
    while true do
        task.wait(0.5)
        
        if not Settings.Enabled then
            continue
        end
        
        pcall(function()
            local MainGui = Player.PlayerGui:FindFirstChild("MainGui")
            if not MainGui then return end
            
            local BattleGui = MainGui:FindFirstChild("MainBattle")
            if not BattleGui or not BattleGui.Visible then 
                lastEncounterID = nil
                return 
            end
            
            local BottomBar = BattleGui:FindFirstChild("BottomBar")
            if not BottomBar then return end
            
            local ActionBar = BottomBar:FindFirstChild("Actions")
            if not ActionBar or not ActionBar.Visible then return end
            
            local battleData = GetBattleData()
            if not battleData then return end
            
            local myDoodle = GetOutDoodle()
            local wildDoodle = GetEnemyDoodle()
            
            if not myDoodle then 
                print("Could not get your doodle")
                return 
            end
            
            if not wildDoodle then
                print("Could not get wild doodle")
                return
            end
            
            local currentID = wildDoodle.ID or tostring(wildDoodle)
            if lastEncounterID == currentID then
                return
            end
            lastEncounterID = currentID
            
            Stats.Encounters = Stats.Encounters + 1
            
            local name = wildDoodle.Name or wildDoodle.RealName or "Unknown"
            local isMisprint = wildDoodle.Shiny or (wildDoodle.Color and wildDoodle.Color ~= "Normal")
            local gender = wildDoodle.Gender or "Unknown"
            local ability = wildDoodle.Ability or wildDoodle.AbilityName or "Unknown"
            local skin = wildDoodle.Skin or wildDoodle.SkinName or "Default"
            
            print(string.format("=== Encounter #%d ===", Stats.Encounters))
            print(string.format("Species: %s", name))
            print(string.format("Misprint: %s", isMisprint and "YES" or "NO"))
            print(string.format("Gender: %s", gender))
            print(string.format("Ability: %s", ability))
            print(string.format("Skin: %s", skin))
            if wildDoodle.HiddenTrait then
                print("Hidden Trait:", wildDoodle.HiddenTrait)
            end
            
            local isMatch, reason = CheckMatch(wildDoodle)
            
            if isMatch then
                print("‚úÖ ===== PERFECT MATCH FOUND! =====")
                print("Reason:", reason)
                Stats.Found = Stats.Found + 1
                
                if not Settings.ChainMode then
                    Settings.Enabled = false
                    print("üéâ Target found! Stopping farm.")
                else
                    Stats.Chain = Stats.Chain + 1
                    print("Chain continued:", Stats.Chain)
                end
                
                print("Not running - let player catch it!")
                return
            else
                print("‚ùå No match -", reason)
                
                ActionBar.Visible = false
                
                if Settings.ChainMode then
                    local isSameSpecies = false
                    if Settings.TargetSpecies ~= "" then
                        local wildName = (wildDoodle.Name or wildDoodle.RealName or ""):lower()
                        local targetName = Settings.TargetSpecies:lower()
                        isSameSpecies = wildName:find(targetName, 1, true) ~= nil
                    end
                    
                    if isSameSpecies then
                        print("Same species - attacking to chain!")
                        Stats.Chain = Stats.Chain + 1
                        
                        if myDoodle.Moves and myDoodle.Moves[Settings.SelectedMoveSlot] then
                            local moveName = myDoodle.Moves[Settings.SelectedMoveSlot].Name
                            print("Using move:", moveName)
                            
                            ClientModule.Network:post("BattleAction", {
                                [1] = {
                                    ["Target"] = wildDoodle.ID,
                                    ["ActionType"] = "Attack",
                                    ["Action"] = moveName,
                                    ["User"] = myDoodle.ID,
                                }
                            })
                        end
                    else
                        print("Different species - running!")
                        ClientModule.Network:post("BattleAction", {
                            [1] = {
                                ["Target"] = "RunAway",
                                ["ActionType"] = "Run",
                                ["User"] = myDoodle.ID,
                            }
                        })
                    end
                else
                    print("Running from battle")
                    ClientModule.Network:post("BattleAction", {
                        [1] = {
                            ["Target"] = "RunAway",
                            ["ActionType"] = "Run",
                            ["User"] = myDoodle.ID,
                        }
                    })
                end
                
                EndTurn()
            end
        end)
    end
end)

-- Create GUI
print("Creating GUI...")

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "DoodleAutoFarmGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 350, 0, 450)
MainFrame.Position = UDim2.new(0.02, 0, 0.5, -225)
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Parent = ScreenGui

local MainCorner = Instance.new("UICorner")
MainCorner.CornerRadius = UDim.new(0, 12)
MainCorner.Parent = MainFrame

-- Title Bar
local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 45)
TitleBar.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
TitleBar.BorderSizePixel = 0
TitleBar.Parent = MainFrame

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 12)
TitleCorner.Parent = TitleBar

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Size = UDim2.new(1, -50, 1, 0)
TitleLabel.Position = UDim2.new(0, 15, 0, 0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text = "üéÆ Doodle Auto Farm"
TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleLabel.TextSize = 18
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.Parent = TitleBar

local CloseBtn = Instance.new("TextButton")
CloseBtn.Size = UDim2.new(0, 35, 0, 35)
CloseBtn.Position = UDim2.new(1, -40, 0, 5)
CloseBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
CloseBtn.Text = "‚úï"
CloseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseBtn.TextSize = 16
CloseBtn.Font = Enum.Font.GothamBold
CloseBtn.Parent = TitleBar

local CloseCorner = Instance.new("UICorner")
CloseCorner.CornerRadius = UDim.new(0, 8)
CloseCorner.Parent = CloseBtn

CloseBtn.MouseButton1Click:Connect(function()
    Settings.Enabled = false
    ScreenGui:Destroy()
end)

-- Tab Container
local TabContainer = Instance.new("Frame")
TabContainer.Size = UDim2.new(1, -20, 0, 40)
TabContainer.Position = UDim2.new(0, 10, 0, 55)
TabContainer.BackgroundTransparency = 1
TabContainer.Parent = MainFrame

local TabLayout = Instance.new("UIListLayout")
TabLayout.FillDirection = Enum.FillDirection.Horizontal
TabLayout.HorizontalAlignment = Enum.HorizontalAlignment.Left
TabLayout.Padding = UDim.new(0, 8)
TabLayout.Parent = TabContainer

-- Content Area
local ContentArea = Instance.new("Frame")
ContentArea.Size = UDim2.new(1, -20, 1, -110)
ContentArea.Position = UDim2.new(0, 10, 0, 100)
ContentArea.BackgroundTransparency = 1
ContentArea.Parent = MainFrame

-- Tab System
local currentTab = nil
local tabs = {}

local function CreateTab(name, icon)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 100, 1, 0)
    btn.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    btn.Text = icon .. " " .. name
    btn.TextColor3 = Color3.fromRGB(200, 200, 200)
    btn.TextSize = 13
    btn.Font = Enum.Font.GothamBold
    btn.Parent = TabContainer
    
    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 8)
    btnCorner.Parent = btn
    
    local content = Instance.new("ScrollingFrame")
    content.Name = name .. "Content"
    content.Size = UDim2.new(1, 0, 1, 0)
    content.BackgroundTransparency = 1
    content.BorderSizePixel = 0
    content.ScrollBarThickness = 6
    content.Visible = false
    content.Parent = ContentArea
    
    local layout = Instance.new("UIListLayout")
    layout.Padding = UDim.new(0, 10)
    layout.SortOrder = Enum.SortOrder.LayoutOrder
    layout.Parent = content
    
    layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        content.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y + 10)
    end)
    
    tabs[name] = {button = btn, content = content}
    
    btn.MouseButton1Click:Connect(function()
        for tabName, tab in pairs(tabs) do
            tab.content.Visible = false
            tab.button.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
            tab.button.TextColor3 = Color3.fromRGB(200, 200, 200)
        end
        
        content.Visible = true
        btn.BackgroundColor3 = Color3.fromRGB(75, 150, 255)
        btn.TextColor3 = Color3.fromRGB(255, 255, 255)
        currentTab = name
    end)
    
    return content
end

-- Create Tabs
local mainTab = CreateTab("Main", "‚öôÔ∏è")
local filtersTab = CreateTab("Filters", "üéØ")
local utilsTab = CreateTab("Utils", "üíö")

-- Show first tab by default
tabs["Main"].button.BackgroundColor3 = Color3.fromRGB(75, 150, 255)
tabs["Main"].button.TextColor3 = Color3.fromRGB(255, 255, 255)
tabs["Main"].content.Visible = true

-- Helper Functions for GUI Elements
local function AddToggle(parent, text, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 40)
    frame.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
    frame.BorderSizePixel = 0
    frame.Parent = parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = frame
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -80, 1, 0)
    label.Position = UDim2.new(0, 15, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 14
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame
    
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 60, 0, 28)
    btn.Position = UDim2.new(1, -70, 0.5, -14)
    btn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    btn.Text = "OFF"
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.TextSize = 12
    btn.Font = Enum.Font.GothamBold
    btn.Parent = frame
    
    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 6)
    btnCorner.Parent = btn
    
    local toggled = false
    btn.MouseButton1Click:Connect(function()
        toggled = not toggled
        btn.BackgroundColor3 = toggled and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(200, 50, 50)
        btn.Text = toggled and "ON" or "OFF"
        callback(toggled)
    end)
    
    return btn
end

local function AddTextInput(parent, placeholder, callback)
    local box = Instance.new("TextBox")
    box.Size = UDim2.new(1, 0, 0, 40)
    box.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
    box.Text = ""
    box.PlaceholderText = placeholder
    box.TextColor3 = Color3.fromRGB(255, 255, 255)
    box.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
    box.TextSize = 13
    box.Font = Enum.Font.Gotham
    box.ClearTextOnFocus = false
    box.Parent = parent
    
    local padding = Instance.new("UIPadding")
    padding.PaddingLeft = UDim.new(0, 15)
    padding.Parent = box
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = box
    
    box.FocusLost:Connect(function()
        callback(box.Text)
    end)
    
    return box
end

local function AddDropdown(parent, placeholder, list, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 40)
    frame.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
    frame.BorderSizePixel = 0
    frame.Parent = parent
    frame.ClipsDescendants = false
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = frame
    
    local searchBox = Instance.new("TextBox")
    searchBox.Size = UDim2.new(1, -20, 1, 0)
    searchBox.Position = UDim2.new(0, 15, 0, 0)
    searchBox.BackgroundTransparency = 1
    searchBox.Text = ""
    searchBox.PlaceholderText = placeholder
    searchBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    searchBox.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
    searchBox.TextSize = 13
    searchBox.Font = Enum.Font.Gotham
    searchBox.ClearTextOnFocus = false
    searchBox.TextXAlignment = Enum.TextXAlignment.Left
    searchBox.Parent = frame
    
    local dropdownList = Instance.new("ScrollingFrame")
    dropdownList.Size = UDim2.new(1, 0, 0, 0)
    dropdownList.Position = UDim2.new(0, 0, 1, 5)
    dropdownList.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    dropdownList.BorderSizePixel = 0
    dropdownList.Visible = false
    dropdownList.ScrollBarThickness = 4
    dropdownList.ZIndex = 100
    dropdownList.Parent = frame
    
    local listCorner = Instance.new("UICorner")
    listCorner.CornerRadius = UDim.new(0, 8)
    listCorner.Parent = dropdownList
    
    local listLayout = Instance.new("UIListLayout")
    listLayout.Padding = UDim.new(0, 3)
    listLayout.SortOrder = Enum.SortOrder.LayoutOrder
    listLayout.Parent = dropdownList
    
    local function updateList(query)
        for _, child in ipairs(dropdownList:GetChildren()) do
            if child:IsA("TextButton") then
                child:Destroy()
            end
        end
        
        if query == "" then
            dropdownList.Visible = false
            return
        end
        
        local matches = {}
        query = query:lower()
        
        for _, item in ipairs(list) do
            if item:lower():find(query, 1, true) then
                table.insert(matches, item)
                if #matches >= 8 then break end
            end
        end
        
        if #matches == 0 then
            dropdownList.Visible = false
            return
        end
        
        for _, item in ipairs(matches) do
            local btn = Instance.new("TextButton")
            btn.Size = UDim2.new(1, -10, 0, 30)
            btn.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
            btn.Text = item
            btn.TextColor3 = Color3.fromRGB(255, 255, 255)
            btn.TextSize = 12
            btn.Font = Enum.Font.Gotham
            btn.Parent = dropdownList
            
            local btnCorner = Instance.new("UICorner")
            btnCorner.CornerRadius = UDim.new(0, 6)
            btnCorner.Parent = btn
            
            btn.MouseButton1Click:Connect(function()
                searchBox.Text = item
                dropdownList.Visible = false
                callback(item)
            end)
            
            btn.MouseEnter:Connect(function()
                btn.BackgroundColor3 = Color3.fromRGB(55, 55, 65)
            end)
            
            btn.MouseLeave:Connect(function()
                btn.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
            end)
        end
        
        dropdownList.Visible = true
        local contentHeight = math.min(listLayout.AbsoluteContentSize.Y + 10, 180)
        dropdownList.Size = UDim2.new(1, 0, 0, contentHeight)
        dropdownList.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y + 10)
    end
    
    searchBox:GetPropertyChangedSignal("Text"):Connect(function()
        updateList(searchBox.Text)
    end)
    
    searchBox.FocusLost:Connect(function()
        task.wait(0.15)
        dropdownList.Visible = false
    end)
end

local function AddSlider(parent, text, min, max, default, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 55)
    frame.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
    frame.BorderSizePixel = 0
    frame.Parent = parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = frame
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -70, 0, 20)
    label.Position = UDim2.new(0, 15, 0, 8)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 13
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame
    
    local valueLabel = Instance.new("TextLabel")
    valueLabel.Size = UDim2.new(0, 60, 0, 20)
    valueLabel.Position = UDim2.new(1, -65, 0, 8)
    valueLabel.BackgroundTransparency = 1
    valueLabel.Text = tostring(default or min)
    valueLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    valueLabel.TextSize = 13
    valueLabel.Font = Enum.Font.GothamBold
    valueLabel.Parent = frame
    
    local bar = Instance.new("Frame")
    bar.Size = UDim2.new(1, -30, 0, 8)
    bar.Position = UDim2.new(0, 15, 1, -18)
    bar.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
    bar.BorderSizePixel = 0
    bar.Parent = frame
    
    local barCorner = Instance.new("UICorner")
    barCorner.CornerRadius = UDim.new(0, 4)
    barCorner.Parent = bar
    
    local fill = Instance.new("Frame")
    local initialPercent = (default - min) / (max - min)
    fill.Size = UDim2.new(initialPercent, 0, 1, 0)
    fill.BackgroundColor3 = Color3.fromRGB(75, 150, 255)
    fill.BorderSizePixel = 0
    fill.Parent = bar
    
    local fillCorner = Instance.new("UICorner")
    fillCorner.CornerRadius = UDim.new(0, 4)
    fillCorner.Parent = fill
    
    local value = default or min
    
    local function update(input)
        local pos = math.clamp((input.Position.X - bar.AbsolutePosition.X) / bar.AbsoluteSize.X, 0, 1)
        value = math.floor(min + (max - min) * pos)
        valueLabel.Text = tostring(value)
        fill.Size = UDim2.new(pos, 0, 1, 0)
        callback(value)
    end
    
    local dragging = false
    bar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            update(input)
        end
    end)
    
    bar.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            update(input)
        end
    end)
end

local function AddButtonGroup(parent, label, options, default, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 45)
    frame.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
    frame.BorderSizePixel = 0
    frame.Parent = parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = frame
    
    local lbl = Instance.new("TextLabel")
    lbl.Size = UDim2.new(0.4, 0, 1, 0)
    lbl.Position = UDim2.new(0, 15, 0, 0)
    lbl.BackgroundTransparency = 1
    lbl.Text = label
    lbl.TextColor3 = Color3.fromRGB(255, 255, 255)
    lbl.TextSize = 13
    lbl.Font = Enum.Font.Gotham
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    lbl.Parent = frame
    
    local buttons = {}
    local btnWidth = (1 - 0.45) / #options
    
    for i, option in ipairs(options) do
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(btnWidth - 0.02, 0, 0, 28)
        btn.Position = UDim2.new(0.42 + (i-1) * btnWidth, 0, 0.5, -14)
        btn.BackgroundColor3 = (option == default) and Color3.fromRGB(75, 150, 255) or Color3.fromRGB(50, 50, 60)
        btn.Text = option
        btn.TextColor3 = Color3.fromRGB(255, 255, 255)
        btn.TextSize = 11
        btn.Font = Enum.Font.GothamBold
        btn.Parent = frame
        
        local btnCorner = Instance.new("UICorner")
        btnCorner.CornerRadius = UDim.new(0, 6)
        btnCorner.Parent = btn
        
        buttons[option] = btn
        
        btn.MouseButton1Click:Connect(function()
            callback(option)
            for opt, b in pairs(buttons) do
                if opt == option then
                    b.BackgroundColor3 = Color3.fromRGB(75, 150, 255)
                else
                    b.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
                end
            end
        end)
    end
end

-- MAIN TAB
AddToggle(mainTab, "Start Farming", function(value)
    Settings.Enabled = value
    print("Farming:", value and "enabled" or "disabled")
    if value then
        Stats.Encounters = 0
        Stats.Chain = 0
    end
end)

AddToggle(mainTab, "Chain Mode (Kill/Run)", function(value)
    Settings.ChainMode = value
end)

AddSlider(mainTab, "Move Slot", 1, 4, 1, function(value)
    Settings.SelectedMoveSlot = value
end)

-- Stats Display
local statsLabel = Instance.new("TextLabel")
statsLabel.Size = UDim2.new(1, 0, 0, 70)
statsLabel.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
statsLabel.BorderSizePixel = 0
statsLabel.Text = "Encounters: 0\nChain: 0\nFound: 0"
statsLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
statsLabel.TextSize = 14
statsLabel.Font = Enum.Font.GothamBold
statsLabel.Parent = mainTab

local statsCorner = Instance.new("UICorner")
statsCorner.CornerRadius = UDim.new(0, 8)
statsCorner.Parent = statsLabel

task.spawn(function()
    while task.wait(1) do
        if statsLabel then
            statsLabel.Text = string.format("Encounters: %d\nChain: %d\nFound: %d", 
                Stats.Encounters, Stats.Chain, Stats.Found)
        end
    end
end)

-- FILTERS TAB
AddDropdown(filtersTab, "üîç Search Doodle Name...", DoodleNames, function(text)
    Settings.TargetSpecies = text
    print("Target:", text == "" and "Any" or text)
end)

AddToggle(filtersTab, "Only Misprint", function(value)
    Settings.OnlyMisprint = value
end)

AddToggle(filtersTab, "Only Hidden Trait", function(value)
    Settings.OnlyHiddenTrait = value
end)

AddTextInput(filtersTab, "Target Ability (exact name)", function(text)
    Settings.TargetAbility = text
    print("Target Ability:", text == "" and "Any" or text)
end)

AddButtonGroup(filtersTab, "Gender:", {"Any", "Male", "Female"}, "Any", function(value)
    Settings.TargetGender = value
    print("Target Gender:", value)
end)

AddButtonGroup(filtersTab, "Skin:", {"Any", "Default", "HasSkin"}, "Any", function(value)
    Settings.TargetSkin = value
    print("Target Skin:", value)
end)

AddTextInput(filtersTab, "Custom Skin Name (exact)", function(text)
    if text ~= "" then
        Settings.TargetSkin = text
        print("Custom Target Skin:", text)
    end
end)

-- UTILS TAB
AddButtonGroup(utilsTab, "Heal Loc:", {"Academy", "Lakewood", "Sweetsville"}, "Academy", function(value)
    Settings.HealLocation = value
    print("Heal Location:", value)
end)

local healBtn = Instance.new("TextButton")
healBtn.Size = UDim2.new(1, 0, 0, 45)
healBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
healBtn.Text = "üíö HEAL TEAM NOW"
healBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
healBtn.TextSize = 14
healBtn.Font = Enum.Font.GothamBold
healBtn.Parent = utilsTab

local healBtnCorner = Instance.new("UICorner")
healBtnCorner.CornerRadius = UDim.new(0, 8)
healBtnCorner.Parent = healBtn

healBtn.MouseButton1Click:Connect(function()
    HealTeam()
end)

AddSlider(utilsTab, "Encounter Delay (s)", 1, 5, 2, function(value)
    Settings.EncounterDelay = value
end)

-- Make draggable
local dragging, dragInput, dragStart, startPos

local function updateDrag(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

TitleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

TitleBar.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        updateDrag(input)
    end
end)

-- Parent GUI
ScreenGui.Parent = Player:WaitForChild("PlayerGui")

print("‚úì GUI created")

-- Encounter Loop
task.spawn(function()
    print("‚úì Encounter loop started")
    local lastZone = nil
    
    while task.wait(1) do
        if Settings.Enabled then
            local char = Player.Character
            if char and char:FindFirstChild("HumanoidRootPart") then
                local zone = nil
                
                for _, obj in ipairs(Workspace:GetChildren()) do
                    if obj.Name:match("^%d%d%d_") or zoneEncounters[obj.Name] then
                        zone = obj.Name
                        break
                    end
                end
                
                if zone ~= lastZone then
                    if zone then
                        print("üìç Zone detected:", zone)
                        if zoneEncounters[zone] then
                            print("‚úì Zone is valid for encounters")
                        else
                            if zone:match("^%d%d%d_") then
                                print("‚úì Auto-adding zone to encounter list")
                                zoneEncounters[zone] = "WildGrass"
                            else
                                warn("‚ö†Ô∏è Zone not in encounter list")
                            end
                        end
                    else
                        print("‚ö†Ô∏è No zone detected")
                    end
                    lastZone = zone
                end
                
                if zone and zoneEncounters[zone] then
                    pcall(function()
                        DudeWhyld:FireServer(zone, zoneEncounters[zone])
                    end)
                    task.wait(Settings.EncounterDelay)
                else
                    task.wait(2)
                end
            end
        end
    end
end)

-- Disable idle kick
pcall(function()
    if getconnections then
        for _, connection in pairs(getconnections(Player.Idled)) do
            connection:Disable()
        end
    end
end)

print("‚úÖ Auto Farm Loaded!")
print("Stand in grass and press Start Farming!")
print("Script will only stop for Doodles that match ALL your filters!")
