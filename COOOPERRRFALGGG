-- Auto Battle Script with GUI Interaction
-- Automatically clicks buttons and handles encounters

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- Wait for game to load
task.wait(2)

-- Initialize global storage
if not _G.AutoBattle then
    _G.AutoBattle = {
        Settings = {
            AutoAttack = false,
            AutoRun = false,
            EnabledMoves = {
                [1] = true,
                [2] = true,
                [3] = true,
                [4] = true
            },
            AttackDelay = 1.5
        },
        BattleData = {
            InBattle = false,
            MoveButtons = {},
            RunButton = nil,
            LastScan = 0
        }
    }
end

local Settings = _G.AutoBattle.Settings
local BattleData = _G.AutoBattle.BattleData

-- Function to click a GUI button
local function clickButton(button)
    if not button or not button.Parent then
        return false
    end
    
    local success = pcall(function()
        -- Method 1: Fire all connections
        for _, signal in pairs({"MouseButton1Click", "MouseButton1Down", "Activated"}) do
            if button[signal] then
                for _, connection in pairs(getconnections(button[signal])) do
                    connection:Fire()
                end
            end
        end
        
        -- Method 2: Simulate mouse click
        task.spawn(function()
            local pos = button.AbsolutePosition
            local size = button.AbsoluteSize
            local x = pos.X + size.X/2
            local y = pos.Y + size.Y/2
            
            VirtualInputManager:SendMouseButtonEvent(x, y, 0, true, game, 0)
            task.wait(0.05)
            VirtualInputManager:SendMouseButtonEvent(x, y, 0, false, game, 0)
        end)
    end)
    
    return success
end

-- Scan for battle GUI elements
local function scanBattleGUI()
    local currentTime = tick()
    if currentTime - BattleData.LastScan < 0.5 then
        return -- Don't scan too frequently
    end
    BattleData.LastScan = currentTime
    
    local PlayerGui = LocalPlayer:FindFirstChild("PlayerGui")
    if not PlayerGui then return end
    
    -- Reset detection
    local foundMoves = {}
    local wasInBattle = BattleData.InBattle
    BattleData.InBattle = false
    
    -- Scan all GUI elements
    for _, gui in pairs(PlayerGui:GetDescendants()) do
        if not gui:IsA("GuiObject") then continue end
        
        local text = ""
        if gui:IsA("TextLabel") or gui:IsA("TextButton") then
            text = gui.Text:lower()
        end
        
        local name = gui.Name:lower()
        
        -- Detect if we're in battle
        if text:match("battle") or text:match("wild") or name:match("battle") or 
           text:match("enemy") or text:match("opponent") then
            BattleData.InBattle = true
        end
        
        -- Detect victory/defeat (battle ended)
        if text:match("victory") or text:match("you won") or text:match("defeated") or 
           text:match("you lost") or text:match("ran away") then
            BattleData.InBattle = false
        end
        
        -- Find move buttons (looking for numbered buttons or move names)
        if gui:IsA("TextButton") and gui.Visible then
            -- Check if it's a move button
            if name:match("move") or name:match("attack") or name:match("skill") or
               text:match("move %d") or (tonumber(text) and tonumber(text) <= 4) then
                
                -- Try to determine which move slot this is
                local moveNum = nil
                if name:match("move1") or name:match("attack1") or text == "1" then
                    moveNum = 1
                elseif name:match("move2") or name:match("attack2") or text == "2" then
                    moveNum = 2
                elseif name:match("move3") or name:match("attack3") or text == "3" then
                    moveNum = 3
                elseif name:match("move4") or name:match("attack4") or text == "4" then
                    moveNum = 4
                end
                
                -- If we couldn't determine the slot, assign sequentially
                if not moveNum then
                    for i = 1, 4 do
                        if not foundMoves[i] then
                            moveNum = i
                            break
                        end
                    end
                end
                
                if moveNum then
                    foundMoves[moveNum] = gui
                end
            end
            
            -- Find run button
            if (text:match("run") or text:match("flee") or text:match("escape") or
                name:match("run") or name:match("flee")) and 
                not text:match("running") then
                BattleData.RunButton = gui
            end
        end
    end
    
    -- Update move buttons
    for i = 1, 4 do
        if foundMoves[i] then
            BattleData.MoveButtons[i] = foundMoves[i]
        end
    end
    
    -- Log battle state changes
    if BattleData.InBattle and not wasInBattle then
        print("[Auto Battle] Entered battle!")
    elseif not BattleData.InBattle and wasInBattle then
        print("[Auto Battle] Left battle!")
    end
end

-- Auto attack logic
local function autoAttackLoop()
    while true do
        task.wait(0.1)
        
        if not Settings.AutoAttack then
            task.wait(1)
            continue
        end
        
        scanBattleGUI()
        
        if not BattleData.InBattle then
            task.wait(0.5)
            continue
        end
        
        -- Try to use enabled moves
        local usedMove = false
        for i = 1, 4 do
            if Settings.EnabledMoves[i] and BattleData.MoveButtons[i] then
                local button = BattleData.MoveButtons[i]
                
                if button.Parent and button.Visible and button.Active ~= false then
                    if clickButton(button) then
                        print("[Auto Attack] Used move", i)
                        usedMove = true
                        task.wait(Settings.AttackDelay)
                        break
                    end
                end
            end
        end
        
        if not usedMove then
            task.wait(0.5)
        end
    end
end

-- Auto run logic
local function autoRunLoop()
    while true do
        task.wait(0.1)
        
        if not Settings.AutoRun then
            task.wait(1)
            continue
        end
        
        scanBattleGUI()
        
        if not BattleData.InBattle then
            task.wait(0.5)
            continue
        end
        
        -- Try to click run button
        if BattleData.RunButton then
            local button = BattleData.RunButton
            
            if button.Parent and button.Visible and button.Active ~= false then
                if clickButton(button) then
                    print("[Auto Run] Clicked run button")
                    task.wait(2) -- Wait before trying again
                end
            end
        end
        
        task.wait(1)
    end
end

-- Start background loops
task.spawn(autoAttackLoop)
task.spawn(autoRunLoop)

-- Create GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AutoBattleGUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- Main Frame
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 300, 0, 360)
MainFrame.Position = UDim2.new(0.5, -150, 0.5, -180)
MainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 10)
UICorner.Parent = MainFrame

-- Title Bar
local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 40)
TitleBar.BackgroundColor3 = Color3.fromRGB(45, 45, 60)
TitleBar.BorderSizePixel = 0
TitleBar.Parent = MainFrame

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 10)
TitleCorner.Parent = TitleBar

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, -80, 1, 0)
Title.Position = UDim2.new(0, 10, 0, 0)
Title.BackgroundTransparency = 1
Title.Text = "Auto Battle"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 18
Title.Font = Enum.Font.GothamBold
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.Parent = TitleBar

-- Close Button
local CloseButton = Instance.new("TextButton")
CloseButton.Size = UDim2.new(0, 30, 0, 30)
CloseButton.Position = UDim2.new(1, -35, 0, 5)
CloseButton.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
CloseButton.Text = "X"
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.TextSize = 16
CloseButton.Font = Enum.Font.GothamBold
CloseButton.BorderSizePixel = 0
CloseButton.Parent = TitleBar

local CloseCorner = Instance.new("UICorner")
CloseCorner.CornerRadius = UDim.new(0, 6)
CloseCorner.Parent = CloseButton

CloseButton.MouseButton1Click:Connect(function()
    Settings.AutoAttack = false
    Settings.AutoRun = false
    ScreenGui:Destroy()
end)

-- Content Frame
local ContentFrame = Instance.new("Frame")
ContentFrame.Size = UDim2.new(1, -20, 1, -60)
ContentFrame.Position = UDim2.new(0, 10, 0, 50)
ContentFrame.BackgroundTransparency = 1
ContentFrame.Parent = MainFrame

-- Function to create toggle button
local function createToggle(name, position, callback)
    local ToggleFrame = Instance.new("Frame")
    ToggleFrame.Size = UDim2.new(1, 0, 0, 40)
    ToggleFrame.Position = position
    ToggleFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 60)
    ToggleFrame.BorderSizePixel = 0
    ToggleFrame.Parent = ContentFrame
    
    local ToggleCorner = Instance.new("UICorner")
    ToggleCorner.CornerRadius = UDim.new(0, 8)
    ToggleCorner.Parent = ToggleFrame
    
    local Label = Instance.new("TextLabel")
    Label.Size = UDim2.new(0.6, 0, 1, 0)
    Label.Position = UDim2.new(0, 10, 0, 0)
    Label.BackgroundTransparency = 1
    Label.Text = name
    Label.TextColor3 = Color3.fromRGB(255, 255, 255)
    Label.TextSize = 14
    Label.Font = Enum.Font.Gotham
    Label.TextXAlignment = Enum.TextXAlignment.Left
    Label.Parent = ToggleFrame
    
    local ToggleButton = Instance.new("TextButton")
    ToggleButton.Size = UDim2.new(0, 60, 0, 25)
    ToggleButton.Position = UDim2.new(1, -70, 0.5, -12.5)
    ToggleButton.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
    ToggleButton.Text = "OFF"
    ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    ToggleButton.TextSize = 12
    ToggleButton.Font = Enum.Font.GothamBold
    ToggleButton.BorderSizePixel = 0
    ToggleButton.Parent = ToggleFrame
    
    local ButtonCorner = Instance.new("UICorner")
    ButtonCorner.CornerRadius = UDim.new(0, 6)
    ButtonCorner.Parent = ToggleButton
    
    local isEnabled = false
    
    ToggleButton.MouseButton1Click:Connect(function()
        isEnabled = not isEnabled
        ToggleButton.Text = isEnabled and "ON" or "OFF"
        ToggleButton.BackgroundColor3 = isEnabled and Color3.fromRGB(50, 220, 100) or Color3.fromRGB(220, 50, 50)
        callback(isEnabled)
    end)
    
    return ToggleButton
end

-- Function to create move toggle
local function createMoveToggle(moveNum, position)
    local MoveFrame = Instance.new("Frame")
    MoveFrame.Size = UDim2.new(0.48, 0, 0, 35)
    MoveFrame.Position = position
    MoveFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 60)
    MoveFrame.BorderSizePixel = 0
    MoveFrame.Parent = ContentFrame
    
    local MoveCorner = Instance.new("UICorner")
    MoveCorner.CornerRadius = UDim.new(0, 8)
    MoveCorner.Parent = MoveFrame
    
    local MoveButton = Instance.new("TextButton")
    MoveButton.Size = UDim2.new(1, -10, 1, -10)
    MoveButton.Position = UDim2.new(0, 5, 0, 5)
    MoveButton.BackgroundColor3 = Color3.fromRGB(50, 220, 100)
    MoveButton.Text = "Move " .. moveNum
    MoveButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    MoveButton.TextSize = 12
    MoveButton.Font = Enum.Font.GothamBold
    MoveButton.BorderSizePixel = 0
    MoveButton.Parent = MoveFrame
    
    local MoveButtonCorner = Instance.new("UICorner")
    MoveButtonCorner.CornerRadius = UDim.new(0, 6)
    MoveButtonCorner.Parent = MoveButton
    
    MoveButton.MouseButton1Click:Connect(function()
        Settings.EnabledMoves[moveNum] = not Settings.EnabledMoves[moveNum]
        MoveButton.BackgroundColor3 = Settings.EnabledMoves[moveNum] and Color3.fromRGB(50, 220, 100) or Color3.fromRGB(220, 50, 50)
    end)
end

-- Create toggles
createToggle("Auto Attack", UDim2.new(0, 0, 0, 0), function(enabled)
    Settings.AutoAttack = enabled
    print("[Auto Attack]", enabled and "Enabled" or "Disabled")
end)

createToggle("Auto Run", UDim2.new(0, 0, 0, 50), function(enabled)
    Settings.AutoRun = enabled
    print("[Auto Run]", enabled and "Enabled" or "Disabled")
end)

-- Moves Label
local MovesLabel = Instance.new("TextLabel")
MovesLabel.Size = UDim2.new(1, 0, 0, 30)
MovesLabel.Position = UDim2.new(0, 0, 0, 110)
MovesLabel.BackgroundTransparency = 1
MovesLabel.Text = "Select Moves to Auto-Use:"
MovesLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
MovesLabel.TextSize = 14
MovesLabel.Font = Enum.Font.GothamBold
MovesLabel.TextXAlignment = Enum.TextXAlignment.Left
MovesLabel.Parent = ContentFrame

-- Create move toggles (2x2 grid)
createMoveToggle(1, UDim2.new(0, 0, 0, 145))
createMoveToggle(2, UDim2.new(0.52, 0, 0, 145))
createMoveToggle(3, UDim2.new(0, 0, 0, 190))
createMoveToggle(4, UDim2.new(0.52, 0, 0, 190))

-- Status Display
local StatusFrame = Instance.new("Frame")
StatusFrame.Size = UDim2.new(1, 0, 0, 60)
StatusFrame.Position = UDim2.new(0, 0, 0, 240)
StatusFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
StatusFrame.BorderSizePixel = 0
StatusFrame.Parent = ContentFrame

local StatusCorner = Instance.new("UICorner")
StatusCorner.CornerRadius = UDim.new(0, 8)
StatusCorner.Parent = StatusFrame

local StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(1, -10, 1, -10)
StatusLabel.Position = UDim2.new(0, 5, 0, 5)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "Status: Waiting for battle..."
StatusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
StatusLabel.TextSize = 11
StatusLabel.Font = Enum.Font.Code
StatusLabel.TextXAlignment = Enum.TextXAlignment.Left
StatusLabel.TextYAlignment = Enum.TextYAlignment.Top
StatusLabel.TextWrapped = true
StatusLabel.Parent = StatusFrame

-- Update status display
task.spawn(function()
    while ScreenGui.Parent do
        task.wait(0.5)
        
        scanBattleGUI()
        
        local status = "Status:\n"
        status = status .. "In Battle: " .. (BattleData.InBattle and "YES" or "NO") .. "\n"
        status = status .. "Moves Found: " .. tostring(#BattleData.MoveButtons) .. "/4\n"
        status = status .. "Run Button: " .. (BattleData.RunButton and "Found" or "Not Found")
        
        StatusLabel.Text = status
    end
end)

-- Parent GUI
if gethui then
    ScreenGui.Parent = gethui()
elseif syn and syn.protect_gui then
    syn.protect_gui(ScreenGui)
    ScreenGui.Parent = game.CoreGui
else
    ScreenGui.Parent = game.CoreGui
end

print("=================================")
print("Auto Battle GUI Loaded!")
print("=================================")
print("- Auto Attack: Automatically uses enabled moves")
print("- Auto Run: Automatically flees from battles")
print("- Toggle moves 1-4 to select which to use")
print("- Script runs continuously in background")
print("=================================")
