-- Doodle World Auto Encounter - FIXED VERSION
print("Loading Auto Farm...")

-- Wait for game
repeat task.wait() until game:IsLoaded()

if game.GameId == 0 then
    game:GetPropertyChangedSignal("GameId"):Wait()
end

-- Services
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local Player = Players.LocalPlayer
if not Player then
    Players:GetPropertyChangedSignal("LocalPlayer"):Wait()
    Player = Players.LocalPlayer
end

print("Player found:", Player.Name)

-- Wait for Remotes
local Remotes = Player:WaitForChild("Remotes", 30)
if not Remotes then
    warn("‚ùå Remotes not found!")
    return
end
print("‚úì Remotes found")

-- Get remotes
local DudeWhyld = Remotes:WaitForChild("DudeWhyld", 10)
local BattleAction = Remotes:WaitForChild("BattleAction", 10)

if not DudeWhyld then
    warn("‚ùå DudeWhyld not found!")
    return
end
print("‚úì DudeWhyld found")

if not BattleAction then
    warn("‚ùå BattleAction not found!")
    return
end
print("‚úì BattleAction found")

-- Get Client
local Client = Player:WaitForChild("Client", 30)
if not Client then
    warn("‚ùå Client not found!")
    return
end

local ClientModule = require(Client)
print("‚úì Client module loaded")

-- Get Database
local Database = nil
local ClientRunner = Player:FindFirstChild("ClientRunner")

if ClientRunner then
    Database = ClientRunner:FindFirstChild("Database")
    if Database then
        print("‚úì Database found in ClientRunner")
    end
end

if not Database and Client then
    Database = Client:FindFirstChild("ClientDatabase") or Client:FindFirstChild("Database")
    if Database then
        print("‚úì Database found in Client")
    end
end

if not Database then
    warn("‚ùå Database not found!")
    return
end

-- Load DoodleInfo
local DoodleInfo = nil
local DoodleInfoModule = Database:FindFirstChild("DoodleInfo")
if DoodleInfoModule then
    local success, err = pcall(function()
        DoodleInfo = require(DoodleInfoModule)
    end)
    
    if success then
        print("‚úì DoodleInfo loaded")
    else
        warn("‚ùå Failed to load DoodleInfo:", err)
        return
    end
else
    warn("‚ùå DoodleInfo module not found!")
    return
end

-- Build Doodle list
local DoodleNames = {}
if DoodleInfo then
    for name, _ in pairs(DoodleInfo) do
        table.insert(DoodleNames, name)
    end
    table.sort(DoodleNames)
    print("‚úì Loaded", #DoodleNames, "Doodles")
end

-- Zone Map
local zoneEncounters = {
    ["025_Sweetsville"] = "WildGrass",
    ["033_Academy"] = "WildGrass",
    ["029_SubwayStation"] = "WildGrass",
    ["TheCarnival"] = "WildGrass",
    ["Route_1"] = "WildGrass",
    ["006_Route2"] = "WildGrass",
    ["007_Lakewood"] = "WildGrass",
    ["008_LakewoodSewers"] = "WildGrass",
    ["011_Sewer"] = "WildGrass",
    ["010_Route3"] = "WildGrass",
    ["013_Route4"] = "WildGrass",
    ["014_GraphiteLodge"] = "WildGrass",
    ["015_GraphiteLodgePath"] = "WildGrass",
    ["017_Crossroads"] = "WildGrass",
    ["018_CrystalCaverns"] = "WildGrass",
    ["020_GraphiteForest"] = "WildGrass",
    ["022_ForestMaze"] = "WildGrass",
    ["024_Route5"] = "WildGrass",
    ["026_VonSweetenManor"] = "WildGrass",
    ["028_PirateCabin"] = "WildGrass",
    ["031_CandyFactory"] = "WildGrass"
}

-- Settings
local Settings = {
    Enabled = false,
    TargetSpecies = "",
    OnlyMisprint = false,
    OnlyHiddenTrait = false,
    TargetAbility = "",
    TargetGender = "Any",
    TargetSkin = "Any",
    ChainMode = false,
    SelectedMoveSlot = 1,
    EncounterDelay = 2,
    HealLocation = "Academy"
}

local Stats = {
    Encounters = 0,
    Chain = 0,
    Found = 0
}

-- Helper Functions
local function GetBattleData()
    local battleData = nil
    
    pcall(function()
        if ClientModule.Battle and ClientModule.Battle.CurrentBattle then
            battleData = ClientModule.Battle.CurrentBattle
        end
    end)
    
    return battleData
end

local function GetOutDoodle()
    local battleData = GetBattleData()
    if not battleData then return nil end
    
    local success, result = pcall(function()
        local MainGui = Player.PlayerGui:FindFirstChild("MainGui")
        if not MainGui then return nil end
        
        local BattleGui = MainGui:FindFirstChild("MainBattle")
        if not BattleGui then return nil end
        
        local InfoHolder = BattleGui:FindFirstChild("BackBox")
        if not InfoHolder then return nil end
        
        local NameLabel = InfoHolder:FindFirstChild("NameLabel")
        local LevelLabel = InfoHolder:FindFirstChild("LevelLabel")
        local Health = InfoHolder:FindFirstChild("Health")
        if not NameLabel or not LevelLabel or not Health then return nil end
        
        local HealthLabel = Health:FindFirstChild("HealthNumber")
        if not HealthLabel then return nil end
        
        local Party = battleData["Player1Party"]
        if not Party then return nil end
        
        local MaxHealth = string.split(HealthLabel.Text,"/")
        MaxHealth = string.gsub(MaxHealth[2]," ","")
        MaxHealth = tonumber(MaxHealth)
        local Level = string.gsub(LevelLabel.Text,"Lv. ","")
        Level = tonumber(Level)
        
        for i,v in pairs(Party) do
            if v.Stats and v.Stats.hp == MaxHealth then
                if v.Name == NameLabel.Text or (v.Doodle and v.Doodle.Nickname == NameLabel.Text) then
                    if v.Level == Level then
                        return v
                    end
                end
            end
        end
        
        for i,v in pairs(Party) do
            if v.Name == NameLabel.Text or (v.Doodle and v.Doodle.Nickname == NameLabel.Text) then
                return v
            end
        end
        
        return Party[1]
    end)
    
    if success then
        return result
    end
    return nil
end

local function GetEnemyDoodle()
    local battleData = GetBattleData()
    if not battleData then return nil end
    
    local success, result = pcall(function()
        if battleData["Player2Party"] and battleData["Player2Party"][1] then
            return battleData["Player2Party"][1]
        end
        return nil
    end)
    
    if success and result then
        return result
    end
    return nil
end

local function CheckMatch(wildDoodle)
    if not wildDoodle then return false, "No Doodle" end
    
    if Settings.TargetSpecies ~= "" then
        local name = (wildDoodle.Name or wildDoodle.RealName or ""):lower()
        local target = Settings.TargetSpecies:lower()
        if not name:find(target, 1, true) then
            return false, "Wrong Species"
        end
    end
    
    local stars = wildDoodle.Star or 0
    if stars < Settings.MinStars then
        return false, "Low Stars (" .. stars .. "/" .. Settings.MinStars .. ")"
    end
    
    if Settings.OnlyMisprint then
        local isMisprint = wildDoodle.Shiny or (wildDoodle.Color and wildDoodle.Color ~= "Normal")
        if not isMisprint then
            return false, "Not Misprint"
        end
    end
    
    if Settings.OnlyHiddenTrait then
        if not wildDoodle.HiddenTrait then
            return false, "No Hidden Trait"
        end
    end
    
    return true, "Match Found!"
end

local function EndTurn()
    pcall(function()
        if getupvalues then
            local UpValues = getupvalues(ClientModule.Network.BindEvent)
            for i,v in pairs(UpValues) do
                if typeof(v) == "table" and v["ForceEnd"] ~= nil then
                    v.ForceEnd()
                    break
                end
            end
        end
    end)
end

local function HealTeam()
    pcall(function()
        print("üíö Healing team at " .. Settings.HealLocation .. "...")
        local args = {
            "Heal",
            Settings.HealLocation
        }
        Player:WaitForChild("Remotes"):WaitForChild("PlayerDataEvent"):FireServer(unpack(args))
        task.wait(1) -- Wait for heal to complete
        print("‚úì Team healed!")
    end)
end

-- Auto Battle Loop (from working script)
local lastEncounterID = nil

task.spawn(function()
    print("‚úì Auto Battle Loop started")
    
    while true do
        task.wait(0.5)
        
        if not Settings.Enabled then
            continue
        end
        
        pcall(function()
            local MainGui = Player.PlayerGui:FindFirstChild("MainGui")
            if not MainGui then return end
            
            local BattleGui = MainGui:FindFirstChild("MainBattle")
            if not BattleGui or not BattleGui.Visible then 
                lastEncounterID = nil
                return 
            end
            
            local BottomBar = BattleGui:FindFirstChild("BottomBar")
            if not BottomBar then return end
            
            local ActionBar = BottomBar:FindFirstChild("Actions")
            if not ActionBar or not ActionBar.Visible then return end
            
            local battleData = GetBattleData()
            if not battleData then return end
            
            local myDoodle = GetOutDoodle()
            local wildDoodle = GetEnemyDoodle()
            
            if not myDoodle then 
                print("Could not get your doodle")
                return 
            end
            
            if not wildDoodle then
                print("Could not get wild doodle")
                return
            end
            
            -- Check if this is a new encounter
            local currentID = wildDoodle.ID or tostring(wildDoodle)
            if lastEncounterID == currentID then
                return
            end
            lastEncounterID = currentID
            
            Stats.Encounters = Stats.Encounters + 1
            
            local name = wildDoodle.Name or wildDoodle.RealName or "Unknown"
            local isMisprint = wildDoodle.Shiny or (wildDoodle.Color and wildDoodle.Color ~= "Normal")
            local gender = wildDoodle.Gender or "Unknown"
            local ability = wildDoodle.Ability or wildDoodle.AbilityName or "Unknown"
            local skin = wildDoodle.Skin or wildDoodle.SkinName or "Default"
            
            print(string.format("=== Encounter #%d ===", Stats.Encounters))
            print(string.format("Species: %s", name))
            print(string.format("Misprint: %s", isMisprint and "YES" or "NO"))
            print(string.format("Gender: %s", gender))
            print(string.format("Ability: %s", ability))
            print(string.format("Skin: %s", skin))
            if wildDoodle.HiddenTrait then
                print("Hidden Trait:", wildDoodle.HiddenTrait)
            end
            
            local isMatch, reason = CheckMatch(wildDoodle)
            
            if isMatch then
                print("‚úÖ ===== MATCH FOUND! =====")
                print("Reason:", reason)
                Stats.Found = Stats.Found + 1
                
                if not Settings.ChainMode then
                    Settings.Enabled = false
                    print("üéâ Target found! Stopping farm.")
                else
                    Stats.Chain = Stats.Chain + 1
                    print("Chain continued:", Stats.Chain)
                end
                
                print("Not running - let player catch it!")
                return
            else
                print("‚ùå No match -", reason)
                
                -- Hide action bar
                ActionBar.Visible = false
                
                if Settings.ChainMode then
                    local isSameSpecies = false
                    if Settings.TargetSpecies ~= "" then
                        local wildName = (wildDoodle.Name or wildDoodle.RealName or ""):lower()
                        local targetName = Settings.TargetSpecies:lower()
                        isSameSpecies = wildName:find(targetName, 1, true) ~= nil
                    end
                    
                    if isSameSpecies then
                        print("Same species - attacking to chain!")
                        Stats.Chain = Stats.Chain + 1
                        
                        if myDoodle.Moves and myDoodle.Moves[Settings.SelectedMoveSlot] then
                            local moveName = myDoodle.Moves[Settings.SelectedMoveSlot].Name
                            print("Using move:", moveName)
                            
                            ClientModule.Network:post("BattleAction", {
                                [1] = {
                                    ["Target"] = wildDoodle.ID,
                                    ["ActionType"] = "Attack",
                                    ["Action"] = moveName,
                                    ["User"] = myDoodle.ID,
                                }
                            })
                        end
                    else
                        print("Different species - running!")
                        ClientModule.Network:post("BattleAction", {
                            [1] = {
                                ["Target"] = "RunAway",
                                ["ActionType"] = "Run",
                                ["User"] = myDoodle.ID,
                            }
                        })
                    end
                else
                    print("Running from battle")
                    ClientModule.Network:post("BattleAction", {
                        [1] = {
                            ["Target"] = "RunAway",
                            ["ActionType"] = "Run",
                            ["User"] = myDoodle.ID,
                        }
                    })
                end
                
                EndTurn()
            end
        end)
    end
end)

-- Create GUI
print("Creating GUI...")

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "DoodleAutoFarmGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 320, 0, 480)
MainFrame.Position = UDim2.new(0.02, 0, 0.5, -240)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Parent = ScreenGui

local MainCorner = Instance.new("UICorner")
MainCorner.CornerRadius = UDim.new(0, 10)
MainCorner.Parent = MainFrame

local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 40)
TitleBar.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
TitleBar.BorderSizePixel = 0
TitleBar.Parent = MainFrame

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 10)
TitleCorner.Parent = TitleBar

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Size = UDim2.new(1, -50, 1, 0)
TitleLabel.Position = UDim2.new(0, 10, 0, 0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text = "üéÆ Doodle Auto Farm"
TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleLabel.TextSize = 16
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.Parent = TitleBar

local CloseBtn = Instance.new("TextButton")
CloseBtn.Size = UDim2.new(0, 30, 0, 30)
CloseBtn.Position = UDim2.new(1, -35, 0, 5)
CloseBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
CloseBtn.Text = "X"
CloseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseBtn.TextSize = 14
CloseBtn.Font = Enum.Font.GothamBold
CloseBtn.Parent = TitleBar

local CloseCorner = Instance.new("UICorner")
CloseCorner.CornerRadius = UDim.new(0, 6)
CloseCorner.Parent = CloseBtn

CloseBtn.MouseButton1Click:Connect(function()
    Settings.Enabled = false
    ScreenGui:Destroy()
end)

local Content = Instance.new("ScrollingFrame")
Content.Size = UDim2.new(1, -20, 1, -60)
Content.Position = UDim2.new(0, 10, 0, 50)
Content.BackgroundTransparency = 1
Content.BorderSizePixel = 0
Content.ScrollBarThickness = 6
Content.Parent = MainFrame

local Layout = Instance.new("UIListLayout")
Layout.Padding = UDim.new(0, 10)
Layout.SortOrder = Enum.SortOrder.LayoutOrder
Layout.Parent = Content

local function AddSection(text)
    local section = Instance.new("TextLabel")
    section.Size = UDim2.new(1, 0, 0, 25)
    section.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
    section.Text = text
    section.TextColor3 = Color3.fromRGB(200, 200, 200)
    section.TextSize = 13
    section.Font = Enum.Font.GothamBold
    section.Parent = Content
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = section
end

local function AddToggle(text, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 35)
    frame.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
    frame.BorderSizePixel = 0
    frame.Parent = Content
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = frame
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -80, 1, 0)
    label.Position = UDim2.new(0, 10, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 13
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame
    
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 60, 0, 25)
    btn.Position = UDim2.new(1, -70, 0.5, -12.5)
    btn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    btn.Text = "OFF"
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.TextSize = 12
    btn.Font = Enum.Font.GothamBold
    btn.Parent = frame
    
    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 6)
    btnCorner.Parent = btn
    
    local toggled = false
    btn.MouseButton1Click:Connect(function()
        toggled = not toggled
        btn.BackgroundColor3 = toggled and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(200, 50, 50)
        btn.Text = toggled and "ON" or "OFF"
        callback(toggled)
    end)
end

local function AddDropdown(text, list, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 32)
    frame.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
    frame.BorderSizePixel = 0
    frame.Parent = Content
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = frame
    
    local searchBox = Instance.new("TextBox")
    searchBox.Size = UDim2.new(1, -10, 1, 0)
    searchBox.Position = UDim2.new(0, 5, 0, 0)
    searchBox.BackgroundTransparency = 1
    searchBox.Text = ""
    searchBox.PlaceholderText = text
    searchBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    searchBox.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
    searchBox.TextSize = 12
    searchBox.Font = Enum.Font.Gotham
    searchBox.ClearTextOnFocus = false
    searchBox.TextXAlignment = Enum.TextXAlignment.Left
    searchBox.Parent = frame
    
    local dropdownList = Instance.new("ScrollingFrame")
    dropdownList.Size = UDim2.new(1, 0, 0, 0)
    dropdownList.Position = UDim2.new(0, 0, 1, 2)
    dropdownList.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
    dropdownList.BorderSizePixel = 0
    dropdownList.Visible = false
    dropdownList.ScrollBarThickness = 4
    dropdownList.ZIndex = 10
    dropdownList.Parent = frame
    
    local listCorner = Instance.new("UICorner")
    listCorner.CornerRadius = UDim.new(0, 6)
    listCorner.Parent = dropdownList
    
    local listLayout = Instance.new("UIListLayout")
    listLayout.Padding = UDim.new(0, 2)
    listLayout.SortOrder = Enum.SortOrder.LayoutOrder
    listLayout.Parent = dropdownList
    
    local function updateList(query)
        for _, child in ipairs(dropdownList:GetChildren()) do
            if child:IsA("TextButton") then
                child:Destroy()
            end
        end
        
        if query == "" then
            dropdownList.Visible = false
            return
        end
        
        local matches = {}
        query = query:lower()
        
        for _, item in ipairs(list) do
            if item:lower():find(query, 1, true) then
                table.insert(matches, item)
                if #matches >= 10 then break end
            end
        end
        
        if #matches == 0 then
            dropdownList.Visible = false
            return
        end
        
        for _, item in ipairs(matches) do
            local btn = Instance.new("TextButton")
            btn.Size = UDim2.new(1, -8, 0, 24)
            btn.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
            btn.Text = item
            btn.TextColor3 = Color3.fromRGB(255, 255, 255)
            btn.TextSize = 11
            btn.Font = Enum.Font.Gotham
            btn.Parent = dropdownList
            
            local btnCorner = Instance.new("UICorner")
            btnCorner.CornerRadius = UDim.new(0, 4)
            btnCorner.Parent = btn
            
            btn.MouseButton1Click:Connect(function()
                searchBox.Text = item
                dropdownList.Visible = false
                callback(item)
            end)
            
            btn.MouseEnter:Connect(function()
                btn.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
            end)
            
            btn.MouseLeave:Connect(function()
                btn.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
            end)
        end
        
        dropdownList.Visible = true
        local contentHeight = math.min(listLayout.AbsoluteContentSize.Y + 4, 150)
        dropdownList.Size = UDim2.new(1, 0, 0, contentHeight)
        dropdownList.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y + 4)
    end
    
    searchBox:GetPropertyChangedSignal("Text"):Connect(function()
        updateList(searchBox.Text)
    end)
    
    searchBox.FocusLost:Connect(function()
        task.wait(0.1)
        dropdownList.Visible = false
    end)
end

local function AddSlider(text, min, max, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 50)
    frame.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
    frame.BorderSizePixel = 0
    frame.Parent = Content
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = frame
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -80, 0, 20)
    label.Position = UDim2.new(0, 10, 0, 5)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 13
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame
    
    local valueLabel = Instance.new("TextLabel")
    valueLabel.Size = UDim2.new(0, 60, 0, 20)
    valueLabel.Position = UDim2.new(1, -70, 0, 5)
    valueLabel.BackgroundTransparency = 1
    valueLabel.Text = tostring(min)
    valueLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    valueLabel.TextSize = 13
    valueLabel.Font = Enum.Font.GothamBold
    valueLabel.Parent = frame
    
    local bar = Instance.new("Frame")
    bar.Size = UDim2.new(1, -20, 0, 6)
    bar.Position = UDim2.new(0, 10, 1, -15)
    bar.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
    bar.BorderSizePixel = 0
    bar.Parent = frame
    
    local barCorner = Instance.new("UICorner")
    barCorner.CornerRadius = UDim.new(0, 3)
    barCorner.Parent = bar
    
    local fill = Instance.new("Frame")
    fill.Size = UDim2.new(0, 0, 1, 0)
    fill.BackgroundColor3 = Color3.fromRGB(75, 150, 255)
    fill.BorderSizePixel = 0
    fill.Parent = bar
    
    local fillCorner = Instance.new("UICorner")
    fillCorner.CornerRadius = UDim.new(0, 3)
    fillCorner.Parent = fill
    
    local value = min
    
    local function update(input)
        local pos = math.clamp((input.Position.X - bar.AbsolutePosition.X) / bar.AbsoluteSize.X, 0, 1)
        value = math.floor(min + (max - min) * pos)
        valueLabel.Text = tostring(value)
        fill.Size = UDim2.new(pos, 0, 1, 0)
        callback(value)
    end
    
    local dragging = false
    bar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            update(input)
        end
    end)
    
    bar.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            update(input)
        end
    end)
end

-- Build GUI
AddSection("‚öôÔ∏è Main Controls")

AddToggle("Start Farming", function(value)
    Settings.Enabled = value
    print("Farming:", value and "enabled" or "disabled")
    if value then
        Stats.Encounters = 0
        Stats.Chain = 0
    end
end)

AddSection("üéØ Filters")

AddDropdown("Search Doodle Name...", DoodleNames, function(text)
    Settings.TargetSpecies = text
    print("Target:", text == "" and "Any" or text)
end)

AddToggle("Only Misprint", function(value)
    Settings.OnlyMisprint = value
end)

AddToggle("Only Hidden Trait", function(value)
    Settings.OnlyHiddenTrait = value
end)

-- Ability input
local abilityBox = Instance.new("TextBox")
abilityBox.Size = UDim2.new(1, 0, 0, 32)
abilityBox.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
abilityBox.Text = ""
abilityBox.PlaceholderText = "Target Ability (leave empty for any)"
abilityBox.TextColor3 = Color3.fromRGB(255, 255, 255)
abilityBox.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
abilityBox.TextSize = 12
abilityBox.Font = Enum.Font.Gotham
abilityBox.ClearTextOnFocus = false
abilityBox.Parent = Content

local abilityCorner = Instance.new("UICorner")
abilityCorner.CornerRadius = UDim.new(0, 6)
abilityCorner.Parent = abilityBox

abilityBox.FocusLost:Connect(function()
    Settings.TargetAbility = abilityBox.Text
    print("Target Ability:", Settings.TargetAbility == "" and "Any" or Settings.TargetAbility)
end)

-- Gender dropdown
local genderFrame = Instance.new("Frame")
genderFrame.Size = UDim2.new(1, 0, 0, 35)
genderFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
genderFrame.BorderSizePixel = 0
genderFrame.Parent = Content

local genderCorner = Instance.new("UICorner")
genderCorner.CornerRadius = UDim.new(0, 6)
genderCorner.Parent = genderFrame

local genderLabel = Instance.new("TextLabel")
genderLabel.Size = UDim2.new(0.5, -5, 1, 0)
genderLabel.Position = UDim2.new(0, 10, 0, 0)
genderLabel.BackgroundTransparency = 1
genderLabel.Text = "Gender:"
genderLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
genderLabel.TextSize = 13
genderLabel.Font = Enum.Font.Gotham
genderLabel.TextXAlignment = Enum.TextXAlignment.Left
genderLabel.Parent = genderFrame

local genderButtons = {}
local genders = {"Any", "Male", "Female"}
for i, gender in ipairs(genders) do
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 55, 0, 25)
    btn.Position = UDim2.new(0.5, (i-2) * 60, 0.5, -12.5)
    btn.BackgroundColor3 = (gender == "Any") and Color3.fromRGB(75, 150, 255) or Color3.fromRGB(60, 60, 60)
    btn.Text = gender
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.TextSize = 11
    btn.Font = Enum.Font.GothamBold
    btn.Parent = genderFrame
    
    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 6)
    btnCorner.Parent = btn
    
    genderButtons[gender] = btn
    
    btn.MouseButton1Click:Connect(function()
        Settings.TargetGender = gender
        print("Target Gender:", gender)
        
        for g, b in pairs(genderButtons) do
            if g == gender then
                b.BackgroundColor3 = Color3.fromRGB(75, 150, 255)
            else
                b.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
            end
        end
    end)
end

-- Skin dropdown
local skinFrame = Instance.new("Frame")
skinFrame.Size = UDim2.new(1, 0, 0, 35)
skinFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
skinFrame.BorderSizePixel = 0
skinFrame.Parent = Content

local skinCorner = Instance.new("UICorner")
skinCorner.CornerRadius = UDim.new(0, 6)
skinCorner.Parent = skinFrame

local skinLabel = Instance.new("TextLabel")
skinLabel.Size = UDim2.new(0.3, -5, 1, 0)
skinLabel.Position = UDim2.new(0, 10, 0, 0)
skinLabel.BackgroundTransparency = 1
skinLabel.Text = "Skin:"
skinLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
skinLabel.TextSize = 13
skinLabel.Font = Enum.Font.Gotham
skinLabel.TextXAlignment = Enum.TextXAlignment.Left
skinLabel.Parent = skinFrame

local skinButtons = {}
local skins = {"Any", "Default", "HasSkin", "Custom"}
local skinPositions = {0, 55, 120, 190}
for i, skin in ipairs(skins) do
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, skin == "Custom" and 60 or 55, 0, 25)
    btn.Position = UDim2.new(0, 85 + skinPositions[i], 0.5, -12.5)
    btn.BackgroundColor3 = (skin == "Any") and Color3.fromRGB(75, 150, 255) or Color3.fromRGB(60, 60, 60)
    btn.Text = skin
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.TextSize = 10
    btn.Font = Enum.Font.GothamBold
    btn.Parent = skinFrame
    
    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 6)
    btnCorner.Parent = btn
    
    skinButtons[skin] = btn
    
    btn.MouseButton1Click:Connect(function()
        if skin == "Custom" then
            -- Show input for custom skin name
            local customSkinBox = Instance.new("TextBox")
            customSkinBox.Size = UDim2.new(1, -20, 0, 30)
            customSkinBox.Position = UDim2.new(0, 10, 1, 5)
            customSkinBox.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
            customSkinBox.Text = ""
            customSkinBox.PlaceholderText = "Enter exact skin name..."
            customSkinBox.TextColor3 = Color3.fromRGB(255, 255, 255)
            customSkinBox.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
            customSkinBox.TextSize = 11
            customSkinBox.Font = Enum.Font.Gotham
            customSkinBox.ClearTextOnFocus = false
            customSkinBox.Parent = skinFrame
            
            local customCorner = Instance.new("UICorner")
            customCorner.CornerRadius = UDim.new(0, 6)
            customCorner.Parent = customSkinBox
            
            customSkinBox.FocusLost:Connect(function()
                if customSkinBox.Text ~= "" then
                    Settings.TargetSkin = customSkinBox.Text
                    print("Target Skin:", Settings.TargetSkin)
                    btn.Text = customSkinBox.Text:sub(1, 6)
                    
                    for s, b in pairs(skinButtons) do
                        if s == "Custom" then
                            b.BackgroundColor3 = Color3.fromRGB(75, 150, 255)
                        else
                            b.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
                        end
                    end
                end
                customSkinBox:Destroy()
            end)
        else
            Settings.TargetSkin = skin
            local displayText = skin == "HasSkin" and "Any Skin" or skin
            print("Target Skin:", displayText)
            
            for s, b in pairs(skinButtons) do
                if s == skin then
                    b.BackgroundColor3 = Color3.fromRGB(75, 150, 255)
                else
                    b.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
                end
            end
        end
    end)
end

AddSection("‚öîÔ∏è Battle Settings")

AddToggle("Chain Mode (Kill/Run)", function(value)
    Settings.ChainMode = value
end)

AddSlider("Move Slot", 1, 4, function(value)
    Settings.SelectedMoveSlot = value
end)

AddSection("üíö Quick Actions")

-- Heal Location dropdown with button
local healFrame = Instance.new("Frame")
healFrame.Size = UDim2.new(1, 0, 0, 70)
healFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
healFrame.BorderSizePixel = 0
healFrame.Parent = Content

local healCorner = Instance.new("UICorner")
healCorner.CornerRadius = UDim.new(0, 6)
healCorner.Parent = healFrame

local healLabel = Instance.new("TextLabel")
healLabel.Size = UDim2.new(1, -20, 0, 20)
healLabel.Position = UDim2.new(0, 10, 0, 5)
healLabel.BackgroundTransparency = 1
healLabel.Text = "Heal Location:"
healLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
healLabel.TextSize = 13
healLabel.Font = Enum.Font.Gotham
healLabel.TextXAlignment = Enum.TextXAlignment.Left
healLabel.Parent = healFrame

local healButtons = {}
local healLocations = {"Academy", "Lakewood", "Sweetsville"}
for i, location in ipairs(healLocations) do
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 68, 0, 22)
    btn.Position = UDim2.new(0, 10 + (i-1) * 73, 0, 28)
    btn.BackgroundColor3 = (location == "Academy") and Color3.fromRGB(75, 150, 255) or Color3.fromRGB(60, 60, 60)
    btn.Text = location
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.TextSize = 10
    btn.Font = Enum.Font.GothamBold
    btn.Parent = healFrame
    
    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 6)
    btnCorner.Parent = btn
    
    healButtons[location] = btn
    
    btn.MouseButton1Click:Connect(function()
        Settings.HealLocation = location
        print("Heal Location:", location)
        
        for loc, b in pairs(healButtons) do
            if loc == location then
                b.BackgroundColor3 = Color3.fromRGB(75, 150, 255)
            else
                b.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
            end
        end
    end)
end

-- Heal Now Button
local healNowBtn = Instance.new("TextButton")
healNowBtn.Size = UDim2.new(1, -20, 0, 28)
healNowBtn.Position = UDim2.new(0, 10, 0, 55)
healNowBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
healNowBtn.Text = "üíö HEAL TEAM NOW"
healNowBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
healNowBtn.TextSize = 13
healNowBtn.Font = Enum.Font.GothamBold
healNowBtn.Parent = healFrame

local healNowCorner = Instance.new("UICorner")
healNowCorner.CornerRadius = UDim.new(0, 6)
healNowCorner.Parent = healNowBtn

healNowBtn.MouseButton1Click:Connect(function()
    HealTeam()
end)

AddSection("üìä Stats")

local statsLabel = Instance.new("TextLabel")
statsLabel.Size = UDim2.new(1, 0, 0, 60)
statsLabel.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
statsLabel.BorderSizePixel = 0
statsLabel.Text = "Encounters: 0\nChain: 0\nFound: 0"
statsLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
statsLabel.TextSize = 13
statsLabel.Font = Enum.Font.GothamBold
statsLabel.Parent = Content

local statsCorner = Instance.new("UICorner")
statsCorner.CornerRadius = UDim.new(0, 6)
statsCorner.Parent = statsLabel

-- Update stats
task.spawn(function()
    while task.wait(1) do
        statsLabel.Text = string.format("Encounters: %d\nChain: %d\nFound: %d", 
            Stats.Encounters, Stats.Chain, Stats.Found)
    end
end)

-- Make draggable
local dragging, dragInput, dragStart, startPos

local function updateDrag(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

TitleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

TitleBar.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        updateDrag(input)
    end
end)

Layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    Content.CanvasSize = UDim2.new(0, 0, 0, Layout.AbsoluteContentSize.Y + 10)
end)

-- Parent GUI
ScreenGui.Parent = Player:WaitForChild("PlayerGui")

print("‚úì GUI created")

-- Encounter Loop
task.spawn(function()
    print("‚úì Encounter loop started")
    local lastZone = nil
    
    while task.wait(1) do
        if Settings.Enabled then
            local char = Player.Character
            if char and char:FindFirstChild("HumanoidRootPart") then
                local zone = nil
                
                for _, obj in ipairs(Workspace:GetChildren()) do
                    if obj.Name:match("^%d%d%d_") or zoneEncounters[obj.Name] then
                        zone = obj.Name
                        break
                    end
                end
                
                if zone ~= lastZone then
                    if zone then
                        print("üìç Zone detected:", zone)
                        if zoneEncounters[zone] then
                            print("‚úì Zone is valid for encounters")
                        else
                            if zone:match("^%d%d%d_") then
                                print("‚úì Auto-adding zone to encounter list")
                                zoneEncounters[zone] = "WildGrass"
                            else
                                warn("‚ö†Ô∏è Zone not in encounter list")
                            end
                        end
                    else
                        print("‚ö†Ô∏è No zone detected")
                    end
                    lastZone = zone
                end
                
                if zone and zoneEncounters[zone] then
                    pcall(function()
                        DudeWhyld:FireServer(zone, zoneEncounters[zone])
                    end)
                    task.wait(Settings.EncounterDelay)
                else
                    task.wait(2)
                end
            end
        end
    end
end)

-- Disable idle kick
pcall(function()
    if getconnections then
        for _, connection in pairs(getconnections(Player.Idled)) do
            connection:Disable()
        end
    end
end)

print("‚úÖ Auto Farm Loaded!")
print("Stand in grass and press Start Farming!")
print("Script will auto-run or auto-attack based on settings")
