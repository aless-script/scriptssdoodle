-- Doodle World Auto Battle Script (Updated Structure)
-- Wait for game to load
repeat task.wait() until game:IsLoaded()

if game.GameId == 0 then
    game:GetPropertyChangedSignal("GameId"):Wait()
end

-- Check if it's Doodle World
if game.GameId ~= 1775919872 then
    warn("This script is only for Doodle World!")
    return
end

local Players = game:GetService("Players")
local Player = Players.LocalPlayer

if not Player then
    Players:GetPropertyChangedSignal("LocalPlayer"):Wait()
    Player = Players.LocalPlayer
end

-- Wait for new structure
local ClientRunner = Player:WaitForChild("ClientRunner", 30)
if not ClientRunner then
    warn("ClientRunner not found!")
    return
end

local Client = Player:WaitForChild("Client", 30)
if not Client then
    warn("Client not found!")
    return
end

local Database = ClientRunner:WaitForChild("Database", 30)
if not Database then
    warn("Database not found!")
    return
end

-- Require the Client module
local ClientModule = require(Client)
print("Client module loaded successfully!")

-- Global Settings
_G.AutoBattle = _G.AutoBattle or {
    AutoAttack = false,
    AutoRun = false,
    SelectedMoves = {nil, nil, nil, nil}
}

-- Helper Functions
local function EndTurn()
    local success, err = pcall(function()
        local UpValues = getupvalues(ClientModule.Network.BindEvent)
        for i,v in pairs(UpValues) do
            if typeof(v) == "table" and v["ForceEnd"] ~= nil then
                v.ForceEnd()
                break
            end
        end
    end)
    if not success then
        warn("EndTurn error:", err)
    end
end

local function GetOutDoodle()
    local success, result = pcall(function()
        local MainGui = Player.PlayerGui:FindFirstChild("MainGui")
        if not MainGui then return nil end
        
        local BattleGui = MainGui:FindFirstChild("MainBattle")
        if not BattleGui then return nil end
        
        if not ClientModule.Battle.CurrentBattle then return nil end
        
        local InfoHolder = BattleGui:FindFirstChild("BackBox")
        if not InfoHolder then return nil end
        
        local NameLabel = InfoHolder:FindFirstChild("NameLabel")
        local LevelLabel = InfoHolder:FindFirstChild("LevelLabel")
        local Health = InfoHolder:FindFirstChild("Health")
        if not NameLabel or not LevelLabel or not Health then return nil end
        
        local HealthLabel = Health:FindFirstChild("HealthNumber")
        if not HealthLabel then return nil end
        
        local Party = ClientModule.Battle.CurrentBattle["Player1Party"]
        local MaxHealth = string.split(HealthLabel.Text,"/")
        MaxHealth = string.gsub(MaxHealth[2]," ","")
        MaxHealth = tonumber(MaxHealth)
        local Level = string.gsub(LevelLabel.Text,"Lv. ","")
        Level = tonumber(Level)
        
        for i,v in pairs(Party) do
            if v.Stats and v.Stats.hp == MaxHealth then
                if v.Name == NameLabel.Text or (v.Doodle and v.Doodle.Nickname == NameLabel.Text) then
                    if v.Level == Level then
                        return v, i
                    end
                end
            end
        end
        
        for i,v in pairs(Party) do
            if v.Name == NameLabel.Text or (v.Doodle and v.Doodle.Nickname == NameLabel.Text) then
                return v, i
            end
        end
        
        return nil
    end)
    
    if success then
        return result
    end
    return nil
end

local function GetEnemyDoodle()
    local success, result = pcall(function()
        local MainGui = Player.PlayerGui:FindFirstChild("MainGui")
        if not MainGui then return nil end
        
        local BattleGui = MainGui:FindFirstChild("MainBattle")
        if not BattleGui then return nil end
        
        if not ClientModule.Battle.CurrentBattle then return nil end
        
        local InfoHolder = BattleGui:FindFirstChild("FrontBox")
        if not InfoHolder then return nil end
        
        local NameLabel = InfoHolder:FindFirstChild("NameLabel")
        if not NameLabel then return nil end
        
        local YourParty = ClientModule.Network:get("PlayerData","GetParty")
        local Party
        
        if ClientModule.Battle.CurrentBattle["Player2Party"][1].ID ~= YourParty[1].ID then
            Party = ClientModule.Battle.CurrentBattle["Player2Party"]
        else
            Party = ClientModule.Battle.CurrentBattle["Player1Party"]
        end
        
        for i,v in pairs(Party) do
            if v.Name == NameLabel.Text or (v.Doodle and v.Doodle.Nickname == NameLabel.Text) then
                return v
            end
        end
        return nil
    end)
    
    if success then
        return result
    end
    return nil
end

local function SwitchDoodle(YourDoodle)
    pcall(function()
        local MainGui = Player.PlayerGui:WaitForChild("MainGui")
        local PartyGui = MainGui:WaitForChild("PartyUI")
        local YourParty = ClientModule.Battle.CurrentBattle["Player1Party"]
        local SelectedDoodle = nil
        
        for i,v in pairs(YourParty) do
            if not SelectedDoodle and v.ID and v.ID ~= YourDoodle.ID then
                if PartyGui:FindFirstChild("Party"..tostring(i)) then
                    local PartyMemberHolder = PartyGui:FindFirstChild("Party"..tostring(i))
                    if PartyMemberHolder:FindFirstChild("Health") and PartyMemberHolder.Health:FindFirstChild("HealthNumber") then
                        local CurrentHealth = string.split(PartyMemberHolder.Health.HealthNumber.Text,"/")
                        CurrentHealth = string.gsub(CurrentHealth[1]," ","")
                        CurrentHealth = tonumber(CurrentHealth)
                        if CurrentHealth ~= 0 then
                            SelectedDoodle = v
                            break
                        end
                    end
                end
            end
        end
        
        if SelectedDoodle then
            ClientModule.Network:post("ForceSwitch",{
                ["Target"] = SelectedDoodle.ID,
                ["ActionType"] = "ForceSwitch",
                ["User"] = YourDoodle.ID,
            })
            EndTurn()
            repeat wait() until PartyGui.Visible == false
        end
    end)
end

local function GetBestMove(YourDoodle, EnemyDoodle)
    -- First, try to use selected moves in order
    for i = 1, 4 do
        if _G.AutoBattle.SelectedMoves[i] then
            for _, move in ipairs(YourDoodle.Moves) do
                if move.Name == _G.AutoBattle.SelectedMoves[i] then
                    return move.Name
                end
            end
        end
    end
    
    -- If no selected moves available, find best matchup
    local BestMatchup = nil
    local HighestMultiplier = -100
    
    pcall(function()
        for i,v in pairs(YourDoodle.Moves) do
            local MoveData = ClientModule.ClientDatabase:GetMoveData(v.Name)
            if MoveData then
                local MoveType = MoveData.Type
                local Multiplier = ClientModule.Typings:GetEffectiveness(YourDoodle, EnemyDoodle, MoveType)
                if MoveData.Power and Multiplier > HighestMultiplier then
                    HighestMultiplier = Multiplier
                    BestMatchup = v.Name
                end
            end
        end
    end)
    
    -- If still no move found, use random
    if not BestMatchup and YourDoodle.Moves and #YourDoodle.Moves > 0 then
        BestMatchup = YourDoodle.Moves[math.random(1, #YourDoodle.Moves)].Name
    end
    
    return BestMatchup
end

-- Auto Battle Loop
local function AutoBattleLoop()
    task.spawn(function()
        while true do
            task.wait(0.5)
            
            if not _G.AutoBattle.AutoAttack and not _G.AutoBattle.AutoRun then
                continue
            end
            
            pcall(function()
                local MainGui = Player.PlayerGui:FindFirstChild("MainGui")
                if not MainGui then return end
                
                local BattleGui = MainGui:FindFirstChild("MainBattle")
                if not BattleGui then return end
                
                local BottomBar = BattleGui:FindFirstChild("BottomBar")
                if not BottomBar then return end
                
                local ActionBar = BottomBar:FindFirstChild("Actions")
                local PartyGui = MainGui:FindFirstChild("PartyUI")
                
                if not ClientModule.Battle.CurrentBattle then return end
                
                if PartyGui and PartyGui.Visible then
                    local YourDoodle = GetOutDoodle()
                    if YourDoodle then
                        SwitchDoodle(YourDoodle)
                    end
                elseif ActionBar and ActionBar.Visible then
                    local YourDoodle = GetOutDoodle()
                    local EnemyDoodle = GetEnemyDoodle()
                    
                    if not YourDoodle or not EnemyDoodle then return end
                    
                    if _G.AutoBattle.AutoRun then
                        ClientModule.Network:post("BattleAction",{
                            [1] = {
                                ["Target"] = "RunAway",
                                ["ActionType"] = "Run",
                                ["User"] = YourDoodle.ID,
                            }
                        })
                        ActionBar.Visible = false
                        EndTurn()
                    elseif _G.AutoBattle.AutoAttack then
                        local MoveToUse = GetBestMove(YourDoodle, EnemyDoodle)
                        
                        if MoveToUse then
                            ClientModule.Network:post("BattleAction",{
                                [1] = {
                                    ["Target"] = EnemyDoodle.ID,
                                    ["ActionType"] = "Attack",
                                    ["Action"] = MoveToUse,
                                    ["User"] = YourDoodle.ID,
                                }
                            })
                            ActionBar.Visible = false
                            EndTurn()
                        end
                    end
                end
            end)
        end
    end)
end

-- Create GUI
print("Creating GUI...")

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AutoBattleGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 320, 0, 380)
MainFrame.Position = UDim2.new(0.5, -160, 0.5, -190)
MainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 10)
UICorner.Parent = MainFrame

local Title = Instance.new("TextLabel")
Title.Name = "Title"
Title.Size = UDim2.new(1, 0, 0, 40)
Title.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
Title.BorderSizePixel = 0
Title.Text = "Auto Battle"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 18
Title.Font = Enum.Font.GothamBold
Title.Parent = MainFrame

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 10)
TitleCorner.Parent = Title

-- Auto Attack Toggle
local AutoAttackBtn = Instance.new("TextButton")
AutoAttackBtn.Name = "AutoAttackBtn"
AutoAttackBtn.Size = UDim2.new(0, 280, 0, 40)
AutoAttackBtn.Position = UDim2.new(0, 20, 0, 60)
AutoAttackBtn.BackgroundColor3 = Color3.fromRGB(255, 75, 75)
AutoAttackBtn.Text = "Auto Attack: OFF"
AutoAttackBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
AutoAttackBtn.TextSize = 16
AutoAttackBtn.Font = Enum.Font.GothamBold
AutoAttackBtn.Parent = MainFrame

local AttackCorner = Instance.new("UICorner")
AttackCorner.CornerRadius = UDim.new(0, 8)
AttackCorner.Parent = AutoAttackBtn

-- Auto Run Toggle
local AutoRunBtn = Instance.new("TextButton")
AutoRunBtn.Name = "AutoRunBtn"
AutoRunBtn.Size = UDim2.new(0, 280, 0, 40)
AutoRunBtn.Position = UDim2.new(0, 20, 0, 110)
AutoRunBtn.BackgroundColor3 = Color3.fromRGB(255, 75, 75)
AutoRunBtn.Text = "Auto Run: OFF"
AutoRunBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
AutoRunBtn.TextSize = 16
AutoRunBtn.Font = Enum.Font.GothamBold
AutoRunBtn.Parent = MainFrame

local RunCorner = Instance.new("UICorner")
RunCorner.CornerRadius = UDim.new(0, 8)
RunCorner.Parent = AutoRunBtn

-- Move Selection Label
local MoveLabel = Instance.new("TextLabel")
MoveLabel.Size = UDim2.new(1, -40, 0, 30)
MoveLabel.Position = UDim2.new(0, 20, 0, 160)
MoveLabel.BackgroundTransparency = 1
MoveLabel.Text = "Move Priority (Select from dropdowns):"
MoveLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
MoveLabel.TextSize = 14
MoveLabel.Font = Enum.Font.Gotham
MoveLabel.TextXAlignment = Enum.TextXAlignment.Left
MoveLabel.Parent = MainFrame

-- Dropdown Functions
local function CreateDropdown(parent, position, index)
    local Dropdown = Instance.new("Frame")
    Dropdown.Size = UDim2.new(0, 280, 0, 35)
    Dropdown.Position = position
    Dropdown.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    Dropdown.BorderSizePixel = 0
    Dropdown.Parent = parent
    
    local DropCorner = Instance.new("UICorner")
    DropCorner.CornerRadius = UDim.new(0, 6)
    DropCorner.Parent = Dropdown
    
    local DropButton = Instance.new("TextButton")
    DropButton.Size = UDim2.new(1, 0, 1, 0)
    DropButton.BackgroundTransparency = 1
    DropButton.Text = "Move " .. index .. ": None"
    DropButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    DropButton.TextSize = 14
    DropButton.Font = Enum.Font.Gotham
    DropButton.Parent = Dropdown
    
    local Arrow = Instance.new("TextLabel")
    Arrow.Size = UDim2.new(0, 20, 1, 0)
    Arrow.Position = UDim2.new(1, -25, 0, 0)
    Arrow.BackgroundTransparency = 1
    Arrow.Text = "â–¼"
    Arrow.TextColor3 = Color3.fromRGB(200, 200, 200)
    Arrow.TextSize = 12
    Arrow.Font = Enum.Font.Gotham
    Arrow.Parent = Dropdown
    
    local DropdownList = Instance.new("ScrollingFrame")
    DropdownList.Size = UDim2.new(1, 0, 0, 0)
    DropdownList.Position = UDim2.new(0, 0, 1, 5)
    DropdownList.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    DropdownList.BorderSizePixel = 0
    DropdownList.Visible = false
    DropdownList.ClipsDescendants = true
    DropdownList.ZIndex = 10
    DropdownList.ScrollBarThickness = 6
    DropdownList.Parent = Dropdown
    
    local ListCorner = Instance.new("UICorner")
    ListCorner.CornerRadius = UDim.new(0, 6)
    ListCorner.Parent = DropdownList
    
    local ListLayout = Instance.new("UIListLayout")
    ListLayout.SortOrder = Enum.SortOrder.LayoutOrder
    ListLayout.Padding = UDim.new(0, 2)
    ListLayout.Parent = DropdownList
    
    local function UpdateMoves()
        for _, child in pairs(DropdownList:GetChildren()) do
            if child:IsA("TextButton") then
                child:Destroy()
            end
        end
        
        -- Add "None" option
        local NoneBtn = Instance.new("TextButton")
        NoneBtn.Size = UDim2.new(1, 0, 0, 30)
        NoneBtn.BackgroundColor3 = Color3.fromRGB(55, 55, 55)
        NoneBtn.BorderSizePixel = 0
        NoneBtn.Text = "None"
        NoneBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        NoneBtn.TextSize = 13
        NoneBtn.Font = Enum.Font.Gotham
        NoneBtn.Parent = DropdownList
        
        NoneBtn.MouseButton1Click:Connect(function()
            _G.AutoBattle.SelectedMoves[index] = nil
            DropButton.Text = "Move " .. index .. ": None"
            DropdownList.Visible = false
        end)
        
        -- Get current doodle moves
        pcall(function()
            if ClientModule.Battle.CurrentBattle then
                local YourDoodle = GetOutDoodle()
                if YourDoodle and YourDoodle.Moves then
                    for _, move in ipairs(YourDoodle.Moves) do
                        local MoveBtn = Instance.new("TextButton")
                        MoveBtn.Size = UDim2.new(1, 0, 0, 30)
                        MoveBtn.BackgroundColor3 = Color3.fromRGB(55, 55, 55)
                        MoveBtn.BorderSizePixel = 0
                        MoveBtn.Text = move.Name
                        MoveBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
                        MoveBtn.TextSize = 13
                        MoveBtn.Font = Enum.Font.Gotham
                        MoveBtn.Parent = DropdownList
                        
                        MoveBtn.MouseButton1Click:Connect(function()
                            _G.AutoBattle.SelectedMoves[index] = move.Name
                            DropButton.Text = "Move " .. index .. ": " .. move.Name
                            DropdownList.Visible = false
                        end)
                    end
                end
            end
        end)
        
        local contentSize = ListLayout.AbsoluteContentSize.Y
        DropdownList.CanvasSize = UDim2.new(0, 0, 0, contentSize)
        DropdownList.Size = UDim2.new(1, 0, 0, math.min(contentSize + 5, 150))
    end
    
    DropButton.MouseButton1Click:Connect(function()
        UpdateMoves()
        DropdownList.Visible = not DropdownList.Visible
    end)
    
    return Dropdown
end

-- Create 4 Dropdowns
local Dropdowns = {}
for i = 1, 4 do
    Dropdowns[i] = CreateDropdown(MainFrame, UDim2.new(0, 20, 0, 190 + (i-1) * 42), i)
end

-- Toggle Functions
AutoAttackBtn.MouseButton1Click:Connect(function()
    _G.AutoBattle.AutoAttack = not _G.AutoBattle.AutoAttack
    if _G.AutoBattle.AutoAttack then
        _G.AutoBattle.AutoRun = false
        AutoAttackBtn.BackgroundColor3 = Color3.fromRGB(75, 255, 75)
        AutoAttackBtn.Text = "Auto Attack: ON"
        AutoRunBtn.BackgroundColor3 = Color3.fromRGB(255, 75, 75)
        AutoRunBtn.Text = "Auto Run: OFF"
    else
        AutoAttackBtn.BackgroundColor3 = Color3.fromRGB(255, 75, 75)
        AutoAttackBtn.Text = "Auto Attack: OFF"
    end
end)

AutoRunBtn.MouseButton1Click:Connect(function()
    _G.AutoBattle.AutoRun = not _G.AutoBattle.AutoRun
    if _G.AutoBattle.AutoRun then
        _G.AutoBattle.AutoAttack = false
        AutoRunBtn.BackgroundColor3 = Color3.fromRGB(75, 255, 75)
        AutoRunBtn.Text = "Auto Run: ON"
        AutoAttackBtn.BackgroundColor3 = Color3.fromRGB(255, 75, 75)
        AutoAttackBtn.Text = "Auto Attack: OFF"
    else
        AutoRunBtn.BackgroundColor3 = Color3.fromRGB(255, 75, 75)
        AutoRunBtn.Text = "Auto Run: OFF"
    end
end)

-- Make GUI Draggable
local dragging
local dragInput
local dragStart
local startPos

local function update(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

Title.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

Title.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

game:GetService("UserInputService").InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        update(input)
    end
end)

-- Parent GUI to PlayerGui
ScreenGui.Parent = Player:WaitForChild("PlayerGui")

print("GUI Created successfully!")

-- Start Auto Battle Loop
AutoBattleLoop()

print("Auto Battle Script Loaded!")
print("_G.AutoBattle settings available globally")
