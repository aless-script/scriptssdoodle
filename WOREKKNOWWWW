-- Doodle World Auto Encounter System - FIXED

-- Robust Environment Setup
local env = nil
local success, result = pcall(function()
    return getgenv and getgenv()
end)
if success and result then
    env = result
else
    env = _G or {}
end

-- Safe wait function
local wait = wait or function(t) 
    local start = tick()
    repeat until tick() - start >= (t or 0.03)
end

-- Wait for game to fully load
repeat wait(0.1) until game:IsLoaded()
wait(1)

local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")

if not Player then
    Players:GetPropertyChangedSignal("LocalPlayer"):Wait()
    Player = Players.LocalPlayer
end

print("Loading Doodle World Auto Farm...")

-- Wait for required components
local Remotes = Player:WaitForChild("Remotes", 30)
if not Remotes then
    warn("Remotes not found!")
    return
end

local Client = Player:WaitForChild("Client", 30)
if not Client then
    warn("Client not found!")
    return
end

local ClientModule = require(Client)
print("Client module loaded!")

-- Load Database
local Database = Client:WaitForChild("Database", 10)
local DoodleInfo = require(Database:WaitForChild("DoodleInfo", 10))
local Skins = require(Database:WaitForChild("Skins", 10)).Sprites

-- Settings
local Enabled = false
local Settings = {
    Doodle = {
        Name = "None",
        Data = {},
    },
    Stars = 1,
    Trait = "Any",
    Skin = "Any",
    Misprint = false,
    Chain = true,
    AutoHeal = true,
    AutoCatch = false,
    BuyCapsules = false,
    Stationary = false,
    FastForward = true,
    RebattlerFarm = false,
    KeepFarming = false
}

local Areas = {"Route_1","006_Route2","007_Lakewood","011_Sewer","010_Route3","013_Route4","014_GraphiteLodge","017_Crossroads","018_CrystalCaverns","020_GraphiteForest","022_ForestMaze","024_Route5","028_PirateCabin","025_Sweetsville","031_CandyFactory"}

local OriginalInventory = ClientModule.Network:get("PlayerData","GetItems")
local DoodleNames = {}
for i,v in pairs(DoodleInfo) do
    table.insert(DoodleNames,i)
end
table.sort(DoodleNames)

local RaycastParams = RaycastParams.new()
RaycastParams.FilterType = Enum.RaycastFilterType.Blacklist

-- Custom GUI Library
local Library = {}
Library.__index = Library

function Library:CreateWindow(title)
    local window = {}
    window.Elements = {}
    
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "DoodleAutofarmGui"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    ScreenGui.Parent = Player:WaitForChild("PlayerGui")
    
    local MainFrame = Instance.new("Frame")
    MainFrame.Name = "MainFrame"
    MainFrame.Size = UDim2.new(0, 400, 0, 600)
    MainFrame.Position = UDim2.new(0.5, -200, 0.5, -300)
    MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    MainFrame.BorderSizePixel = 0
    MainFrame.Parent = ScreenGui
    
    local MainCorner = Instance.new("UICorner")
    MainCorner.CornerRadius = UDim.new(0, 10)
    MainCorner.Parent = MainFrame
    
    local TitleBar = Instance.new("Frame")
    TitleBar.Name = "TitleBar"
    TitleBar.Size = UDim2.new(1, 0, 0, 40)
    TitleBar.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
    TitleBar.BorderSizePixel = 0
    TitleBar.Parent = MainFrame
    
    local TitleCorner = Instance.new("UICorner")
    TitleCorner.CornerRadius = UDim.new(0, 10)
    TitleCorner.Parent = TitleBar
    
    local TitleLabel = Instance.new("TextLabel")
    TitleLabel.Name = "TitleLabel"
    TitleLabel.Size = UDim2.new(1, -50, 1, 0)
    TitleLabel.Position = UDim2.new(0, 10, 0, 0)
    TitleLabel.BackgroundTransparency = 1
    TitleLabel.Text = title
    TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    TitleLabel.TextSize = 18
    TitleLabel.Font = Enum.Font.GothamBold
    TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
    TitleLabel.Parent = TitleBar
    
    local CloseButton = Instance.new("TextButton")
    CloseButton.Name = "CloseButton"
    CloseButton.Size = UDim2.new(0, 30, 0, 30)
    CloseButton.Position = UDim2.new(1, -35, 0, 5)
    CloseButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    CloseButton.Text = "X"
    CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    CloseButton.TextSize = 16
    CloseButton.Font = Enum.Font.GothamBold
    CloseButton.Parent = TitleBar
    
    local CloseCorner = Instance.new("UICorner")
    CloseCorner.CornerRadius = UDim.new(0, 8)
    CloseCorner.Parent = CloseButton
    
    CloseButton.MouseButton1Click:Connect(function()
        ScreenGui:Destroy()
    end)
    
    local ContentFrame = Instance.new("ScrollingFrame")
    ContentFrame.Name = "ContentFrame"
    ContentFrame.Size = UDim2.new(1, -20, 1, -60)
    ContentFrame.Position = UDim2.new(0, 10, 0, 50)
    ContentFrame.BackgroundTransparency = 1
    ContentFrame.BorderSizePixel = 0
    ContentFrame.ScrollBarThickness = 6
    ContentFrame.Parent = MainFrame
    
    local ContentLayout = Instance.new("UIListLayout")
    ContentLayout.Padding = UDim.new(0, 8)
    ContentLayout.SortOrder = Enum.SortOrder.LayoutOrder
    ContentLayout.Parent = ContentFrame
    
    window.ScreenGui = ScreenGui
    window.MainFrame = MainFrame
    window.ContentFrame = ContentFrame
    window.ContentLayout = ContentLayout
    
    local dragging, dragStart, startPos
    
    TitleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = MainFrame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    local dragInput
    TitleBar.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    
    ContentLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        ContentFrame.CanvasSize = UDim2.new(0, 0, 0, ContentLayout.AbsoluteContentSize.Y + 10)
    end)
    
    function window:Section(text)
        local SectionLabel = Instance.new("TextLabel")
        SectionLabel.Size = UDim2.new(1, 0, 0, 30)
        SectionLabel.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
        SectionLabel.BorderSizePixel = 0
        SectionLabel.Text = text
        SectionLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
        SectionLabel.TextSize = 14
        SectionLabel.Font = Enum.Font.GothamBold
        SectionLabel.Parent = self.ContentFrame
        
        local SectionCorner = Instance.new("UICorner")
        SectionCorner.CornerRadius = UDim.new(0, 6)
        SectionCorner.Parent = SectionLabel
        
        return SectionLabel
    end
    
    function window:Toggle(text, options, callback)
        local ToggleFrame = Instance.new("Frame")
        ToggleFrame.Size = UDim2.new(1, 0, 0, 35)
        ToggleFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
        ToggleFrame.BorderSizePixel = 0
        ToggleFrame.Parent = self.ContentFrame
        
        local ToggleCorner = Instance.new("UICorner")
        ToggleCorner.CornerRadius = UDim.new(0, 6)
        ToggleCorner.Parent = ToggleFrame
        
        local ToggleLabel = Instance.new("TextLabel")
        ToggleLabel.Size = UDim2.new(1, -80, 1, 0)
        ToggleLabel.Position = UDim2.new(0, 10, 0, 0)
        ToggleLabel.BackgroundTransparency = 1
        ToggleLabel.Text = text
        ToggleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        ToggleLabel.TextSize = 14
        ToggleLabel.Font = Enum.Font.Gotham
        ToggleLabel.TextXAlignment = Enum.TextXAlignment.Left
        ToggleLabel.Parent = ToggleFrame
        
        local ToggleButton = Instance.new("TextButton")
        ToggleButton.Size = UDim2.new(0, 60, 0, 25)
        ToggleButton.Position = UDim2.new(1, -70, 0.5, -12.5)
        ToggleButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
        ToggleButton.Text = "OFF"
        ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        ToggleButton.TextSize = 12
        ToggleButton.Font = Enum.Font.GothamBold
        ToggleButton.Parent = ToggleFrame
        
        local ButtonCorner = Instance.new("UICorner")
        ButtonCorner.CornerRadius = UDim.new(0, 6)
        ButtonCorner.Parent = ToggleButton
        
        local toggled = false
        ToggleButton.MouseButton1Click:Connect(function()
            toggled = not toggled
            if toggled then
                ToggleButton.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
                ToggleButton.Text = "ON"
            else
                ToggleButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
                ToggleButton.Text = "OFF"
            end
            callback(toggled)
        end)
        
        return {Object = ToggleButton, Frame = ToggleFrame}
    end
    
    function window:Slider(text, options, callback)
        local SliderFrame = Instance.new("Frame")
        SliderFrame.Size = UDim2.new(1, 0, 0, 50)
        SliderFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
        SliderFrame.BorderSizePixel = 0
        SliderFrame.Parent = self.ContentFrame
        
        local SliderCorner = Instance.new("UICorner")
        SliderCorner.CornerRadius = UDim.new(0, 6)
        SliderCorner.Parent = SliderFrame
        
        local SliderLabel = Instance.new("TextLabel")
        SliderLabel.Size = UDim2.new(1, -80, 0, 20)
        SliderLabel.Position = UDim2.new(0, 10, 0, 5)
        SliderLabel.BackgroundTransparency = 1
        SliderLabel.Text = text
        SliderLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        SliderLabel.TextSize = 14
        SliderLabel.Font = Enum.Font.Gotham
        SliderLabel.TextXAlignment = Enum.TextXAlignment.Left
        SliderLabel.Parent = SliderFrame
        
        local ValueLabel = Instance.new("TextLabel")
        ValueLabel.Size = UDim2.new(0, 60, 0, 20)
        ValueLabel.Position = UDim2.new(1, -70, 0, 5)
        ValueLabel.BackgroundTransparency = 1
        ValueLabel.Text = tostring(options.min or 0)
        ValueLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
        ValueLabel.TextSize = 14
        ValueLabel.Font = Enum.Font.GothamBold
        ValueLabel.Parent = SliderFrame
        
        local SliderBar = Instance.new("Frame")
        SliderBar.Size = UDim2.new(1, -20, 0, 6)
        SliderBar.Position = UDim2.new(0, 10, 1, -15)
        SliderBar.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
        SliderBar.BorderSizePixel = 0
        SliderBar.Parent = SliderFrame
        
        local BarCorner = Instance.new("UICorner")
        BarCorner.CornerRadius = UDim.new(0, 3)
        BarCorner.Parent = SliderBar
        
        local SliderFill = Instance.new("Frame")
        SliderFill.Size = UDim2.new(0, 0, 1, 0)
        SliderFill.BackgroundColor3 = Color3.fromRGB(75, 150, 255)
        SliderFill.BorderSizePixel = 0
        SliderFill.Parent = SliderBar
        
        local FillCorner = Instance.new("UICorner")
        FillCorner.CornerRadius = UDim.new(0, 3)
        FillCorner.Parent = SliderFill
        
        local min = options.min or 0
        local max = options.max or 100
        local currentValue = min
        
        local function updateSlider(input)
            local pos = math.clamp((input.Position.X - SliderBar.AbsolutePosition.X) / SliderBar.AbsoluteSize.X, 0, 1)
            currentValue = math.floor(min + (max - min) * pos)
            ValueLabel.Text = tostring(currentValue)
            SliderFill.Size = UDim2.new(pos, 0, 1, 0)
            callback(currentValue)
        end
        
        local dragging = false
        SliderBar.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = true
                updateSlider(input)
            end
        end)
        
        SliderBar.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)
        
        UserInputService.InputChanged:Connect(function(input)
            if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                updateSlider(input)
            end
        end)
        
        return {Object = SliderBar, ValueLabel = ValueLabel}
    end
    
    function window:SearchBox(text, options, callback)
        local SearchFrame = Instance.new("Frame")
        SearchFrame.Size = UDim2.new(1, 0, 0, 35)
        SearchFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
        SearchFrame.BorderSizePixel = 0
        SearchFrame.Parent = self.ContentFrame
        
        local SearchCorner = Instance.new("UICorner")
        SearchCorner.CornerRadius = UDim.new(0, 6)
        SearchCorner.Parent = SearchFrame
        
        local SearchLabel = Instance.new("TextLabel")
        SearchLabel.Size = UDim2.new(0.4, 0, 1, 0)
        SearchLabel.Position = UDim2.new(0, 10, 0, 0)
        SearchLabel.BackgroundTransparency = 1
        SearchLabel.Text = text
        SearchLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        SearchLabel.TextSize = 14
        SearchLabel.Font = Enum.Font.Gotham
        SearchLabel.TextXAlignment = Enum.TextXAlignment.Left
        SearchLabel.Parent = SearchFrame
        
        local SearchBox = Instance.new("TextBox")
        SearchBox.Size = UDim2.new(0.55, -10, 0, 25)
        SearchBox.Position = UDim2.new(0.45, 0, 0.5, -12.5)
        SearchBox.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
        SearchBox.Text = ""
        SearchBox.PlaceholderText = "Search or type..."
        SearchBox.TextColor3 = Color3.fromRGB(255, 255, 255)
        SearchBox.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
        SearchBox.TextSize = 12
        SearchBox.Font = Enum.Font.Gotham
        SearchBox.ClearTextOnFocus = false
        SearchBox.Parent = SearchFrame
        
        local BoxCorner = Instance.new("UICorner")
        BoxCorner.CornerRadius = UDim.new(0, 6)
        BoxCorner.Parent = SearchBox
        
        local ResultsList = Instance.new("Frame")
        ResultsList.Size = UDim2.new(0.55, -10, 0, 0)
        ResultsList.Position = UDim2.new(0.45, 0, 1, 5)
        ResultsList.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
        ResultsList.BorderSizePixel = 0
        ResultsList.Visible = false
        ResultsList.ZIndex = 10
        ResultsList.Parent = SearchFrame
        
        local ResultsCorner = Instance.new("UICorner")
        ResultsCorner.CornerRadius = UDim.new(0, 6)
        ResultsCorner.Parent = ResultsList
        
        local ResultsScroll = Instance.new("ScrollingFrame")
        ResultsScroll.Size = UDim2.new(1, -4, 1, -4)
        ResultsScroll.Position = UDim2.new(0, 2, 0, 2)
        ResultsScroll.BackgroundTransparency = 1
        ResultsScroll.BorderSizePixel = 0
        ResultsScroll.ScrollBarThickness = 4
        ResultsScroll.Parent = ResultsList
        
        local ResultsLayout = Instance.new("UIListLayout")
        ResultsLayout.Padding = UDim.new(0, 2)
        ResultsLayout.SortOrder = Enum.SortOrder.LayoutOrder
        ResultsLayout.Parent = ResultsScroll
        
        local function updateResults(query)
            for _, child in ipairs(ResultsScroll:GetChildren()) do
                if child:IsA("TextButton") then
                    child:Destroy()
                end
            end
            
            if query == "" or not options.list then
                ResultsList.Visible = false
                return
            end
            
            local matches = {}
            query = query:lower()
            
            for _, item in ipairs(options.list) do
                if item:lower():find(query, 1, true) then
                    table.insert(matches, item)
                end
            end
            
            if #matches == 0 then
                ResultsList.Visible = false
                return
            end
            
            for _, item in ipairs(matches) do
                local ItemButton = Instance.new("TextButton")
                ItemButton.Size = UDim2.new(1, -8, 0, 25)
                ItemButton.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
                ItemButton.Text = item
                ItemButton.TextColor3 = Color3.fromRGB(255, 255, 255)
                ItemButton.TextSize = 12
                ItemButton.Font = Enum.Font.Gotham
                ItemButton.TextTruncate = Enum.TextTruncate.AtEnd
                ItemButton.Parent = ResultsScroll
                
                local ItemCorner = Instance.new("UICorner")
                ItemCorner.CornerRadius = UDim.new(0, 4)
                ItemCorner.Parent = ItemButton
                
                ItemButton.MouseButton1Click:Connect(function()
                    SearchBox.Text = item
                    ResultsList.Visible = false
                    callback(item)
                end)
                
                ItemButton.MouseEnter:Connect(function()
                    ItemButton.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
                end)
                
                ItemButton.MouseLeave:Connect(function()
                    ItemButton.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
                end)
            end
            
            ResultsList.Visible = true
            local contentHeight = math.min(ResultsLayout.AbsoluteContentSize.Y + 4, 200)
            ResultsList.Size = UDim2.new(0.55, -10, 0, contentHeight)
            ResultsScroll.CanvasSize = UDim2.new(0, 0, 0, ResultsLayout.AbsoluteContentSize.Y + 4)
        end
        
        SearchBox:GetPropertyChangedSignal("Text"):Connect(function()
            updateResults(SearchBox.Text)
        end)
        
        SearchBox.FocusLost:Connect(function(enterPressed)
            if enterPressed and SearchBox.Text ~= "" then
                callback(SearchBox.Text)
            end
            task.wait(0.1)
            ResultsList.Visible = false
        end)
        
        return {Object = SearchBox, Frame = SearchFrame}
    end
    
    return window
end

-- Create GUI
local Window = Library:CreateWindow("Doodle Autofarm v2.0")
Window:Section("Main Controls")

local GuiObjects = {}

GuiObjects.EnabledToggle = Window:Toggle("Start Farming", {}, function(value)
    Enabled = value
end)

Window:Section("Autofarm Options")

GuiObjects.ChainToggle = Window:Toggle("Build Chain", {}, function(value)
    Settings.Chain = value
end)

GuiObjects.AutoHealToggle = Window:Toggle("Auto Heal", {}, function(value)
    Settings.AutoHeal = value
end)

GuiObjects.StationaryToggle = Window:Toggle("Current Spot Only", {}, function(value)
    Settings.Stationary = value
end)

Window:Section("Catch Filters")

GuiObjects.StarSlider = Window:Slider("Minimum Stars", {min=1, max=6}, function(value)
    Settings.Stars = value
end)

GuiObjects.DoodleSelection = Window:SearchBox("Doodle to Catch", {list=DoodleNames}, function(input)
    if DoodleInfo[input] then
        Settings.Doodle = {Name = input, Data = DoodleInfo[input]}
    else
        Settings.Doodle = {Name = "None", Data = {}}
    end
end)

-- Disable idle kick
pcall(function()
    for i,v in pairs(getconnections(Player.Idled)) do
        v:Disable()
    end
end)

print("âœ… Doodle Autofarm Loaded!")
