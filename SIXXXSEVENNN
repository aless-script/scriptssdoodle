-- Combined Auto Encounter & Chain Hunter
-- Optimized and Compact GUI

-- Safety checks
if not game or not game.GetService then return end

local function getEnv()
    return (getgenv and getgenv()) or _G
end

local env = getEnv()
env.AutoEncounter = {
    Active = false,
    ChainMode = false,
    CurrentZone = nil,
    Delay = 2,
    Filters = {
        Species = "",
        Shiny = false,
        Misprint = false,
        HiddenTrait = false,
        Gender = "Any", -- Any, Male, Female
        MinStars = 0,
        MinIV = 0
    },
    Stats = {
        Encounters = 0,
        Chain = 0
    }
}

local player = game:GetService("Players").LocalPlayer
local remotes = player:WaitForChild("Remotes", 10)
if not remotes then return end
local dudeWhyld = remotes:WaitForChild("DudeWhyld", 5)
local startBattle = remotes:WaitForChild("StartBattle", 5)

-- Zone Map
local zoneEncounters = {
    ["025_Sweetsville"] = "WildGrass",
    ["033_Academy"] = "WildGrass",
    ["029_SubwayStation"] = "WildGrass",
    ["TheCarnival"] = "WildGrass",
    -- Add more if needed or rely on auto-detection
}

-- GUI Creation
local gui = Instance.new("ScreenGui")
gui.Name = "CompactAutoEncounter"
gui.ResetOnSpawn = false
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local main = Instance.new("Frame")
main.Name = "MainFrame"
main.Size = UDim2.new(0, 220, 0, 320) -- Compact size
main.Position = UDim2.new(0.05, 0, 0.5, -160)
main.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
main.BorderSizePixel = 0
main.Active = true
main.Draggable = true
main.Parent = gui

local uicorner = Instance.new("UICorner")
uicorner.CornerRadius = UDim.new(0, 8)
uicorner.Parent = main

-- Header
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -30, 0, 30)
title.Position = UDim2.new(0, 10, 0, 0)
title.BackgroundTransparency = 1
title.Text = "‚öîÔ∏è Auto Encounter"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.GothamBold
title.TextSize = 14
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = main

local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 25, 0, 25)
closeBtn.Position = UDim2.new(1, -30, 0, 2.5)
closeBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
closeBtn.Text = "X"
closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
closeBtn.Font = Enum.Font.GothamBold
closeBtn.Parent = main
Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0, 4)

closeBtn.MouseButton1Click:Connect(function()
    env.AutoEncounter.Active = false
    gui:Destroy()
end)

-- Info Display (The requested fields)
local infoFrame = Instance.new("Frame")
infoFrame.Size = UDim2.new(1, -20, 0, 160)
infoFrame.Position = UDim2.new(0, 10, 0, 35)
infoFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
infoFrame.Parent = main
Instance.new("UICorner", infoFrame).CornerRadius = UDim.new(0, 6)

local function createInfoLine(order, labelText)
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -10, 0, 18)
    label.Position = UDim2.new(0, 5, 0, (order - 1) * 18 + 5)
    label.BackgroundTransparency = 1
    label.Text = labelText .. ": -"
    label.TextColor3 = Color3.fromRGB(200, 200, 200)
    label.Font = Enum.Font.Gotham
    label.TextSize = 11
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = infoFrame
    return label
end

local infoLabels = {
    Name = createInfoLine(1, "Name"),
    Stars = createInfoLine(2, "Stars"),
    Trait = createInfoLine(3, "Trait"),
    Gender = createInfoLine(4, "Gender"),
    Misprint = createInfoLine(5, "Misprint"),
    Item = createInfoLine(6, "Item"),
    Equip = createInfoLine(7, "Equip"),
    Skin = createInfoLine(8, "Skin"),
}

-- Controls
local controlFrame = Instance.new("Frame")
controlFrame.Size = UDim2.new(1, -20, 0, 110)
controlFrame.Position = UDim2.new(0, 10, 0, 200)
controlFrame.BackgroundTransparency = 1
controlFrame.Parent = main

-- Mode Toggle
local chainModeBtn = Instance.new("TextButton")
chainModeBtn.Size = UDim2.new(1, 0, 0, 25)
chainModeBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
chainModeBtn.Text = "Chain Mode: OFF"
chainModeBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
chainModeBtn.Font = Enum.Font.Gotham
chainModeBtn.TextSize = 12
chainModeBtn.Parent = controlFrame
Instance.new("UICorner", chainModeBtn).CornerRadius = UDim.new(0, 6)

chainModeBtn.MouseButton1Click:Connect(function()
    env.AutoEncounter.ChainMode = not env.AutoEncounter.ChainMode
    if env.AutoEncounter.ChainMode then
        chainModeBtn.BackgroundColor3 = Color3.fromRGB(50, 150, 255)
        chainModeBtn.Text = "Chain Mode: ON"
        chainModeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    else
        chainModeBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
        chainModeBtn.Text = "Chain Mode: OFF"
        chainModeBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
    end
end)

-- Target Species Input (Only relevant for Chain Mode)
local speciesInput = Instance.new("TextBox")
speciesInput.Size = UDim2.new(1, 0, 0, 25)
speciesInput.Position = UDim2.new(0, 0, 0, 30)
speciesInput.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
speciesInput.Text = ""
speciesInput.PlaceholderText = "Target Species (for Chain)"
speciesInput.TextColor3 = Color3.fromRGB(255, 255, 255)
speciesInput.Font = Enum.Font.Gotham
speciesInput.TextSize = 12
speciesInput.Parent = controlFrame
Instance.new("UICorner", speciesInput).CornerRadius = UDim.new(0, 6)

speciesInput:GetPropertyChangedSignal("Text"):Connect(function()
    env.AutoEncounter.Filters.Species = speciesInput.Text
end)

-- Start/Stop
local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(1, 0, 0, 35)
toggleBtn.Position = UDim2.new(0, 0, 1, -35)
toggleBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 100)
toggleBtn.Text = "‚ñ∂Ô∏è Start"
toggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleBtn.Font = Enum.Font.GothamBold
toggleBtn.TextSize = 14
toggleBtn.Parent = controlFrame
Instance.new("UICorner", toggleBtn).CornerRadius = UDim.new(0, 6)

toggleBtn.MouseButton1Click:Connect(function()
    env.AutoEncounter.Active = not env.AutoEncounter.Active
    if env.AutoEncounter.Active then
        toggleBtn.Text = "‚è∏Ô∏è Stop"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
    else
        toggleBtn.Text = "‚ñ∂Ô∏è Start"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 100)
    end
end)

-- Logic
local function updateDisplay(data)
    if not data then return end
    infoLabels.Name.Text = "Name: " .. (data.Name or data.RealName or "Unknown")
    infoLabels.Stars.Text = "Stars: " .. (data.Star or 0) .. "‚≠ê"
    infoLabels.Trait.Text = "Trait: " .. (data.Trait or "None")
    
    local gender = "Genderless"
    if data.Gender == "Male" then gender = "‚ôÇ Male" end
    if data.Gender == "Female" then gender = "‚ôÄ Female" end
    infoLabels.Gender.Text = "Gender: " .. gender
    
    local misprint = "No"
    if data.Shiny then misprint = "Shiny" end
    if data.Color and data.Color ~= "Normal" then misprint = data.Color end
    infoLabels.Misprint.Text = "Misprint: " .. misprint
    
    infoLabels.Item.Text = "Item: " .. (data.Item or "None")
    infoLabels.Equip.Text = "Equip: " .. (data.Equipment or "None")
    infoLabels.Skin.Text = "Skin: " .. (data.Skin or "None")
end

local function checkMatch(data)
    if env.AutoEncounter.Filters.Species ~= "" then
        local name = (data.Name or data.RealName or ""):lower()
        if not name:find(env.AutoEncounter.Filters.Species:lower()) then
            return false
        end
    end
    -- Add other filter checks here if we add UI for them (Stars, etc.)
    return true
end

-- Battle Event Hook
startBattle.OnClientEvent:Connect(function(battleData)
    if not env.AutoEncounter.Active then return end
    
    local wildDoodle = battleData.Player2Party and battleData.Player2Party[1]
    if wildDoodle then
        updateDisplay(wildDoodle)
        
        if env.AutoEncounter.ChainMode then
            local isMatch = checkMatch(wildDoodle)
            if isMatch then
                -- Found target!
                env.AutoEncounter.Active = false
                toggleBtn.Text = "üéâ Found!"
                toggleBtn.BackgroundColor3 = Color3.fromRGB(255, 215, 0)
            else
                -- Not match, assume we run or defeat to chain?
                -- For simple "Auto Encounter", usually we just want to encounter. 
                -- "Chain Hunter" implies we might want to automate the battle result.
                -- Since user just asked to "add the script", I'll assume they want the info & basic loop.
                -- If they want auto-run/auto-kill, that logic would go here.
                -- For now, just updating display is key.
            end
        end
    end
end)

-- Main Loop
task.spawn(function()
    while task.wait(1) do
        if env.AutoEncounter.Active then
            local char = player.Character
            if char and char:FindFirstChild("HumanoidRootPart") then
                -- Zone detection
                local zone = nil
                -- Simple zone detection from nearby objects or predefined list
                -- (Simplified for compactness, use your original detection logic here)
                -- For now, relying on user or simple existence check
                
                -- Trigger
                if dudeWhyld then
                     -- Use last known zone or iterate
                     -- (Implementing the simple trigger logic from script 1)
                     local workspace = game:GetService("Workspace")
                     for _, obj in ipairs(workspace:GetChildren()) do
                        if obj.Name:match("^%d%d%d_") or zoneEncounters[obj.Name] then
                            zone = obj.Name
                            break
                        end
                     end
                     
                     if zone and zoneEncounters[zone] then
                         pcall(function()
                             dudeWhyld:FireServer(zone, zoneEncounters[zone])
                         end)
                     end
                end
            end
            task.wait(env.AutoEncounter.Delay)
        end
    end
end)

-- Safe Parent
local success = pcall(function()
    gui.Parent = game:GetService
