-- Combined Auto Encounter & Chain Hunter
-- Fixed auto-battle, auto-run, and auto-detection

-- Safety checks
if not game or not game.GetService then return end

-- Initialize _G.AutoEncounter first before using it
_G.AutoEncounter = _G.AutoEncounter or {
    Active = false,
    ChainMode = false,
    CurrentZone = nil,
    Delay = 2,
    InBattle = false,
    Filters = {
        Species = "",
        Shiny = false,
        Misprint = false,
        HiddenTrait = false,
        Gender = "Any",
        MinStars = 0,
        MinIV = 0,
        MoveName = "Scratch"
    },
    Stats = {
        Encounters = 0,
        Chain = 0
    }
}

-- Use local reference
local env = _G

local player = game:GetService("Players").LocalPlayer
local remotes = player:WaitForChild("Remotes", 10)
if not remotes then return end
local dudeWhyld = remotes:WaitForChild("DudeWhyld", 5)
local startBattle = remotes:WaitForChild("StartBattle", 5)

-- Get Client for proper battle API access
local Client = nil
local ActionBar = nil
local PartyGui = nil
task.spawn(function()
    pcall(function()
        local playerGui = player:WaitForChild("PlayerGui", 10)
        local gui = playerGui and playerGui:WaitForChild("Gui", 10)
        local clientScript = gui and gui:WaitForChild("Client", 10)
        if clientScript and getsenv then
            Client = getsenv(clientScript)
            -- Get battle UI elements
            if gui then
                ActionBar = gui:WaitForChild("ActionBar", 5)
                PartyGui = gui:WaitForChild("Party", 5)
            end
        end
    end)
end)

-- Zone Map (expanded)
local zoneEncounters = {
    ["025_Sweetsville"] = "WildGrass",
    ["033_Academy"] = "WildGrass",
    ["029_SubwayStation"] = "WildGrass",
    ["TheCarnival"] = "WildGrass",
    ["026_CrystalCaverns"] = "WildGrass",
    ["027_VolcanicCove"] = "WildGrass",
    ["028_FrozenTundra"] = "WildGrass",
}

-- GUI Creation
local gui = Instance.new("ScreenGui")
gui.Name = "CompactAutoEncounter"
gui.ResetOnSpawn = false
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local main = Instance.new("Frame")
main.Name = "MainFrame"
main.Size = UDim2.new(0, 220, 0, 450)
main.Position = UDim2.new(0.05, 0, 0.5, -225)
main.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
main.BorderSizePixel = 0
main.Active = true
main.Draggable = true
main.Parent = gui

local uicorner = Instance.new("UICorner")
uicorner.CornerRadius = UDim.new(0, 8)
uicorner.Parent = main

-- Header
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -30, 0, 30)
title.Position = UDim2.new(0, 10, 0, 0)
title.BackgroundTransparency = 1
title.Text = "‚öîÔ∏è Auto Encounter"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.GothamBold
title.TextSize = 14
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = main

local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 25, 0, 25)
closeBtn.Position = UDim2.new(1, -30, 0, 2.5)
closeBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
closeBtn.Text = "X"
closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
closeBtn.Font = Enum.Font.GothamBold
closeBtn.Parent = main
Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0, 4)

closeBtn.MouseButton1Click:Connect(function()
    env.AutoEncounter.Active = false
    gui:Destroy()
end)

-- Info Display
local infoFrame = Instance.new("Frame")
infoFrame.Size = UDim2.new(1, -20, 0, 160)
infoFrame.Position = UDim2.new(0, 10, 0, 35)
infoFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
infoFrame.Parent = main
Instance.new("UICorner", infoFrame).CornerRadius = UDim.new(0, 6)

local function createInfoLine(order, labelText)
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -10, 0, 18)
    label.Position = UDim2.new(0, 5, 0, (order - 1) * 18 + 5)
    label.BackgroundTransparency = 1
    label.Text = labelText .. ": -"
    label.TextColor3 = Color3.fromRGB(200, 200, 200)
    label.Font = Enum.Font.Gotham
    label.TextSize = 11
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = infoFrame
    return label
end

local infoLabels = {
    Name = createInfoLine(1, "Name"),
    Stars = createInfoLine(2, "Stars"),
    Trait = createInfoLine(3, "Trait"),
    Gender = createInfoLine(4, "Gender"),
    Misprint = createInfoLine(5, "Misprint"),
    Item = createInfoLine(6, "Item"),
    Equip = createInfoLine(7, "Equip"),
    Skin = createInfoLine(8, "Skin"),
}

-- Controls
local controlFrame = Instance.new("Frame")
controlFrame.Size = UDim2.new(1, -20, 0, 170)
controlFrame.Position = UDim2.new(0, 10, 0, 200)
controlFrame.BackgroundTransparency = 1
controlFrame.Parent = main

-- Mode Toggle
local chainModeBtn = Instance.new("TextButton")
chainModeBtn.Size = UDim2.new(1, 0, 0, 25)
chainModeBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
chainModeBtn.Text = "Chain Mode: OFF"
chainModeBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
chainModeBtn.Font = Enum.Font.Gotham
chainModeBtn.TextSize = 12
chainModeBtn.Parent = controlFrame
Instance.new("UICorner", chainModeBtn).CornerRadius = UDim.new(0, 6)

chainModeBtn.MouseButton1Click:Connect(function()
    env.AutoEncounter.ChainMode = not env.AutoEncounter.ChainMode
    if env.AutoEncounter.ChainMode then
        chainModeBtn.BackgroundColor3 = Color3.fromRGB(50, 150, 255)
        chainModeBtn.Text = "Chain Mode: ON"
        chainModeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    else
        chainModeBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
        chainModeBtn.Text = "Chain Mode: OFF"
        chainModeBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
    end
end)

-- Target Species Input
local speciesInput = Instance.new("TextBox")
speciesInput.Size = UDim2.new(1, 0, 0, 25)
speciesInput.Position = UDim2.new(0, 0, 0, 30)
speciesInput.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
speciesInput.Text = ""
speciesInput.PlaceholderText = "Target Species"
speciesInput.TextColor3 = Color3.fromRGB(255, 255, 255)
speciesInput.Font = Enum.Font.Gotham
speciesInput.TextSize = 12
speciesInput.Parent = controlFrame
Instance.new("UICorner", speciesInput).CornerRadius = UDim.new(0, 6)
speciesInput:GetPropertyChangedSignal("Text"):Connect(function() env.AutoEncounter.Filters.Species = speciesInput.Text end)

-- Min Stars Input
local starsInput = Instance.new("TextBox")
starsInput.Size = UDim2.new(0.48, 0, 0, 25)
starsInput.Position = UDim2.new(0, 0, 0, 60)
starsInput.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
starsInput.Text = ""
starsInput.PlaceholderText = "Min Stars"
starsInput.TextColor3 = Color3.fromRGB(255, 255, 255)
starsInput.Font = Enum.Font.Gotham
starsInput.TextSize = 12
starsInput.Parent = controlFrame
Instance.new("UICorner", starsInput).CornerRadius = UDim.new(0, 6)
starsInput:GetPropertyChangedSignal("Text"):Connect(function() env.AutoEncounter.Filters.MinStars = tonumber(starsInput.Text) or 0 end)

-- Hidden Trait Toggle
local htBtn = Instance.new("TextButton")
htBtn.Size = UDim2.new(0.48, 0, 0, 25)
htBtn.Position = UDim2.new(0.52, 0, 0, 60)
htBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
htBtn.Text = "HT: OFF"
htBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
htBtn.Font = Enum.Font.Gotham
htBtn.TextSize = 11
htBtn.Parent = controlFrame
Instance.new("UICorner", htBtn).CornerRadius = UDim.new(0, 6)
htBtn.MouseButton1Click:Connect(function()
    env.AutoEncounter.Filters.HiddenTrait = not env.AutoEncounter.Filters.HiddenTrait
    htBtn.Text = env.AutoEncounter.Filters.HiddenTrait and "HT: ON" or "HT: OFF"
    htBtn.BackgroundColor3 = env.AutoEncounter.Filters.HiddenTrait and Color3.fromRGB(50, 150, 255) or Color3.fromRGB(60, 60, 65)
    htBtn.TextColor3 = env.AutoEncounter.Filters.HiddenTrait and Color3.fromRGB(255, 255, 255) or Color3.fromRGB(200, 200, 200)
end)

-- Move Name Input
local moveInput = Instance.new("TextBox")
moveInput.Size = UDim2.new(1, 0, 0, 25)
moveInput.Position = UDim2.new(0, 0, 0, 90)
moveInput.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
moveInput.Text = "Scratch"
moveInput.PlaceholderText = "Move Name (for Kill)"
moveInput.TextColor3 = Color3.fromRGB(255, 255, 255)
moveInput.Font = Enum.Font.Gotham
moveInput.TextSize = 12
moveInput.Parent = controlFrame
Instance.new("UICorner", moveInput).CornerRadius = UDim.new(0, 6)
moveInput:GetPropertyChangedSignal("Text"):Connect(function() env.AutoEncounter.Filters.MoveName = moveInput.Text end)

-- Start/Stop
local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(1, 0, 0, 35)
toggleBtn.Position = UDim2.new(0, 0, 1, -35)
toggleBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 100)
toggleBtn.Text = "‚ñ∂Ô∏è Start"
toggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleBtn.Font = Enum.Font.GothamBold
toggleBtn.TextSize = 14
toggleBtn.Parent = controlFrame
Instance.new("UICorner", toggleBtn).CornerRadius = UDim.new(0, 6)

toggleBtn.MouseButton1Click:Connect(function()
    env.AutoEncounter.Active = not env.AutoEncounter.Active
    if env.AutoEncounter.Active then
        toggleBtn.Text = "‚è∏Ô∏è Stop"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
    else
        toggleBtn.Text = "‚ñ∂Ô∏è Start"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 100)
    end
end)

-- Logic Functions
local function updateDisplay(data)
    if not data then return end
    infoLabels.Name.Text = "Name: " .. (data.Name or data.RealName or "Unknown")
    infoLabels.Stars.Text = "Stars: " .. (data.Star or 0) .. "‚≠ê"
    
    local trait = data.Trait or data.HiddenTrait or data.Ability or "None"
    infoLabels.Trait.Text = "Trait: " .. tostring(trait)
    
    local gender = "Genderless"
    if data.Gender == "Male" then gender = "‚ôÇ Male" end
    if data.Gender == "Female" then gender = "‚ôÄ Female" end
    infoLabels.Gender.Text = "Gender: " .. gender
    
    local misprint = "No"
    if data.Shiny then misprint = "Shiny" end
    if data.Color and data.Color ~= "Normal" then misprint = data.Color end
    infoLabels.Misprint.Text = "Misprint: " .. misprint
    
    infoLabels.Item.Text = "Item: " .. (data.Item or "None")
    infoLabels.Equip.Text = "Equip: " .. (data.Equipment or "None")
    infoLabels.Skin.Text = "Skin: " .. (data.Skin or "None")
end

local function checkMatch(data)
    if env.AutoEncounter.Filters.Species ~= "" then
        local name = (data.Name or data.RealName or ""):lower()
        if not name:find(env.AutoEncounter.Filters.Species:lower()) then
            return false, "Species Mismatch"
        end
    end
    
    if (data.Star or 0) < env.AutoEncounter.Filters.MinStars then
        return false, "Low Stars"
    end
    
    if env.AutoEncounter.Filters.HiddenTrait then
        if not data.HiddenTrait then
            return false, "No HT"
        end
    end

    return true, "Match"
end

-- Improved battle action with better timing
local function executeBattleAction(YourDoodle, EnemyDoodle, actionType)
    if not Client or not Client.Network then 
        warn("[AutoEncounter] Client.Network not available")
        return 
    end
    
    -- Wait for battle to be fully loaded
    local maxWait = 50
    local waited = 0
    while waited < maxWait do
        if ActionBar and ActionBar.Visible == true then
            break
        end
        if Client.Battle and Client.Battle.CurrentBattle == nil then
            return -- Battle ended
        end
        task.wait(0.1)
        waited = waited + 1
    end
    
    -- Additional delay to ensure battle is ready
    task.wait(0.5)
    
    if actionType == "run" then
        pcall(function()
            Client.Network:post("BattleAction", {
                [1] = {
                    ["Target"] = "RunAway",
                    ["ActionType"] = "Run",
                    ["User"] = YourDoodle.ID,
                }
            })
            print("[AutoEncounter] Running away from battle")
        end)
        
    elseif actionType == "attack" then
        local BestMove = nil
        local HighestMultiplier = -100
        
        -- Try to find the best move based on type effectiveness
        if Client.ClientDatabase and Client.Typings and YourDoodle.Moves then
            pcall(function()
                for i, v in pairs(YourDoodle.Moves) do
                    local MoveData = Client.ClientDatabase:GetMoveData(v.Name)
                    if MoveData and MoveData.Type then
                        local MoveType = MoveData.Type
                        local Multiplier = 1
                        
                        -- Try to get type effectiveness
                        local success, result = pcall(function()
                            return Client.Typings:GetEffectiveness(YourDoodle, EnemyDoodle, MoveType)
                        end)
                        
                        if success then
                            Multiplier = result or 1
                        end
                        
                        -- Check if this is a better move
                        if MoveData.Power and MoveData.Power > 0 and Multiplier > HighestMultiplier then
                            HighestMultiplier = Multiplier
                            BestMove = v.Name
                        end
                    end
                end
            end)
        end
        
        -- If no best move found, use first available move
        if not BestMove and YourDoodle.Moves and #YourDoodle.Moves > 0 then
            BestMove = YourDoodle.Moves[1].Name
        end
        
        -- Execute the attack
        if BestMove then
            pcall(function()
                Client.Network:post("BattleAction", {
                    [1] = {
                        ["Target"] = EnemyDoodle.ID,
                        ["ActionType"] = "Attack",
                        ["Action"] = BestMove,
                        ["User"] = YourDoodle.ID,
                    }
                })
                print("[AutoEncounter] Attacking with:", BestMove, "| Effectiveness:", HighestMultiplier)
            end)
        else
            warn("[AutoEncounter] No moves available to attack with")
        end
    end
end

-- Battle Event Hook with improved logic
startBattle.OnClientEvent:Connect(function(battleData)
    if not env.AutoEncounter.Active then return end
    
    env.AutoEncounter.InBattle = true
    
    local wildDoodle = battleData.Player2Party and battleData.Player2Party[1]
    local myDoodle = battleData.Player1Party and battleData.Player1Party[1]
    
    if not wildDoodle or not myDoodle then
        env.AutoEncounter.InBattle = false
        return
    end
    
    updateDisplay(wildDoodle)
    env.AutoEncounter.Stats.Encounters = env.AutoEncounter.Stats.Encounters + 1
    
    if env.AutoEncounter.ChainMode then
        local isMatch, reason = checkMatch(wildDoodle)
        local speciesMatch = env.AutoEncounter.Filters.Species == "" or 
                           (wildDoodle.Name or ""):lower():find(env.AutoEncounter.Filters.Species:lower())
        
        if isMatch then
            -- Perfect match found!
            env.AutoEncounter.Active = false
            env.AutoEncounter.InBattle = false
            toggleBtn.Text = "üéâ Found!"
            toggleBtn.BackgroundColor3 = Color3.fromRGB(255, 215, 0)
            print("[AutoEncounter] ‚ú® MATCH FOUND! ‚ú®", wildDoodle.Name)
        else
            print("[AutoEncounter] Check: Species=" .. tostring(speciesMatch) .. " | " .. reason)
            
            -- Spawn battle action in separate thread
            task.spawn(function()
                if speciesMatch then
                    -- Right species, wrong stats - kill to maintain chain
                    print("[AutoEncounter] ‚öîÔ∏è Killing for chain (Species match, " .. reason .. ")")
                    executeBattleAction(myDoodle, wildDoodle, "attack")
                    env.AutoEncounter.Stats.Chain = env.AutoEncounter.Stats.Chain + 1
                else
                    -- Wrong species - run away
                    print("[AutoEncounter] üèÉ Running (Wrong species)")
                    executeBattleAction(myDoodle, wildDoodle, "run")
                    env.AutoEncounter.Stats.Chain = 0 -- Reset chain
                end
                
                -- Wait for battle to end before allowing new encounter
                task.wait(2)
                env.AutoEncounter.InBattle = false
            end)
        end
    else
        -- Not in chain mode, just run from everything
        task.spawn(function()
            executeBattleAction(myDoodle, wildDoodle, "run")
            task.wait(2)
            env.AutoEncounter.InBattle = false
        end)
    end
end)

-- Improved zone detection
local function detectCurrentZone()
    local workspace = game:GetService("Workspace")
    local char = player.Character
    
    if not char or not char:FindFirstChild("HumanoidRootPart") then
        return nil
    end
    
    local hrp = char.HumanoidRootPart
    local position = hrp.Position
    
    -- Check all workspace children for zone folders
    for _, obj in ipairs(workspace:GetChildren()) do
        -- Check if it's a zone folder (numbered or named)
        if obj:IsA("Folder") or obj:IsA("Model") then
            if obj.Name:match("^%d%d%d_") or zoneEncounters[obj.Name] then
                -- Check if player is near this zone
                local zonePart = obj:FindFirstChildWhichIsA("BasePart", true)
                if zonePart then
                    local distance = (position - zonePart.Position).Magnitude
                    if distance < 500 then -- Within 500 studs
                        return obj.Name
                    end
                end
            end
        end
    end
    
    -- Fallback: return any zone in the list
    for zoneName, _ in pairs(zoneEncounters) do
        local zoneObj = workspace:FindFirstChild(zoneName)
        if zoneObj then
            return zoneName
        end
    end
    
    return nil
end

-- Main Loop with improved encounter triggering
task.spawn(function()
    while task.wait(0.5) do
        if env.AutoEncounter.Active and not env.AutoEncounter.InBattle then
            local char = player.Character
            if char and char:FindFirstChild("HumanoidRootPart") then
                -- Detect zone
                local zone = detectCurrentZone()
                
                if zone and zoneEncounters[zone] and dudeWhyld then
                    local encounterType = zoneEncounters[zone]
                    
                    -- Fire encounter request
                    local success, err = pcall(function()
                        dudeWhyld:FireServer(zone, encounterType)
                    end)
                    
                    if success then
                        print("[AutoEncounter] Triggered encounter in:", zone)
                    else
                        warn("[AutoEncounter] Failed to trigger:", err)
                    end
                    
                    -- Wait for encounter delay
                    task.wait(env.AutoEncounter.Delay)
                end
            end
        end
    end
end)

-- Safe Parent
local success = pcall(function()
    gui.Parent = game:GetService("CoreGui")
end)
if not success then 
    gui.Parent = player.PlayerGui 
end

print("[AutoEncounter] Script loaded successfully!")
