-- [[ DATA SCRAPING ]]
local DoodleList = {"None"}
for i, v in pairs(DoodleInfo) do
    if v.Name then
        table.insert(DoodleList, v.Name)
    end
end
table.sort(DoodleList)

local Inventory = Client.Network:get("PlayerData", "GetItems")
local CapsuleList = {}
if Inventory and Inventory.Capsules then
    for name, _ in pairs(Inventory.Capsules) do
        table.insert(CapsuleList, name)
    end
else
    CapsuleList = {"Basic Capsule", "Polkadot Capsule", "Crystal Capsule"}
end

-- [[ UI CONFIGURATION ]]
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/Kinlei/MaterialLua/master/Module.lua"))()
local Window = Library.Load({
    Title = "Aidez | Doodle World Autofarm",
    Style = 3,
    SizeX = 400,
    SizeY = 500,
    Theme = "Dark"
})

local MainTab = Window.NewTab({Name = "Autofarm"})
local ConfigTab = Window.NewTab({Name = "Config"})

-- [[ MAIN TAB ]]
MainTab.Toggle({
    Text = "Master Autofarm",
    Callback = function(v) Settings.Enabled = v end
})

-- FIXED: Now uses the scraped DoodleList
MainTab.Dropdown({
    Text = "Target Doodle",
    Options = DoodleList,
    Callback = function(v)
        Settings.TargetDoodle = v
    end
})

MainTab.Slider({
    Text = "Minimum Stars",
    Min = 0, Max = 6, Default = 0,
    Callback = function(v) Settings.MinStars = v end
})

-- [[ CONFIG TAB ]]
ConfigTab.Toggle({
    Text = "Auto Catch Misprints",
    Default = true,
    Callback = function(v) Settings.CatchMisprint = v end
})

ConfigTab.Toggle({
    Text = "Auto Heal (Lakewood)",
    Default = true,
    Callback = function(v) Settings.AutoHeal = v end
})

ConfigTab.Toggle({
    Text = "Chain Mode",
    Default = false,
    Callback = function(v) Settings.ChainMode = v end
})

-- FIXED: Now uses your actual inventory
ConfigTab.Dropdown({
    Text = "Capture Item",
    Options = CapsuleList,
    Callback = function(v) Settings.Capsule = v end
})

-- [[ THE BRAIN ]]
-- (Ensure your snippets for CheckGrass, FindEncounters, GetEnemyDoodle are pasted above this line)

task.spawn(function()
    while task.wait(0.5) do
        if not Settings.Enabled then continue end
        
        local Battle = Client.Battle and Client.Battle.CurrentBattle
        
        if not Battle then
            -- 1. Check HP
            if Settings.AutoHeal then
                local Party = Client.Network:get("PlayerData", "GetParty")
                for _, d in pairs(Party) do
                    if d.currenthp and d.currenthp < (d.hp * 0.4) then
                        Client.Network:post("PlayerData", "Heal", "Lakewood")
                        task.wait(1) break
                    end
                end
            end

            -- 2. Find Location (Using your snippet logic)
            local GrassArea = CheckGrass()
            if Settings.TargetDoodle ~= "None" then
                local TargetChunk, TargetGrass = FindEncounters(Settings.TargetDoodle)
                local CurrentChunk = Client.DataManager.RegionData.ChunkName or Client.DataManager.RegionData.Reference
                if TargetChunk and CurrentChunk ~= TargetChunk then
                    pcall(ChangeLocation, TargetChunk)
                    task.wait(1.5)
                end
                GrassArea = TargetGrass
            end

            -- 3. Trigger Battle
            if GrassArea then
                Client.Battle.WildBattIe(nil, nil, GrassArea)
            end
        else
            -- 4. Battle Logic (Using your identification logic)
            local Enemy = GetEnemyDoodle()
            local Mine = GetOutDoodle()
            
            if Enemy and Mine then
                local ShouldCatch = (Enemy.Star >= Settings.MinStars) or (Settings.CatchMisprint and Enemy.Shiny)
                
                if ShouldCatch then
                    Client.Network:post("BattleAction", {{
                        ["ActionType"] = "Item",
                        ["Action"] = Settings.Capsule,
                        ["User"] = Mine.ID
                    }})
                elseif Settings.ChainMode then
                    Client.Network:post("BattleAction", {{
                        ["Target"] = Enemy.ID,
                        ["ActionType"] = "Attack",
                        ["Action"] = Mine.Moves[1].Name,
                        ["User"] = Mine.ID
                    }})
                else
                    Client.Network:post("BattleAction", {{
                        ["Target"] = "RunAway",
                        ["ActionType"] = "Run",
                        ["User"] = Mine.ID
                    }})
                end
                
                -- Skip animations using the upvalue trick
                local UpValues = getupvalues(Client.Network.BindEvent)
                for _, v in pairs(UpValues) do
                    if typeof(v) == "table" and v.ForceEnd then v.ForceEnd() end
                end
            end
        end
    end
end)
