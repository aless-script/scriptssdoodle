-- 1. WAIT FOR GAME DATA
local player = game:GetService("Players").LocalPlayer
local packer = player:WaitForChild("Packer")
local database = packer:WaitForChild("Database")
local client = require(packer:WaitForChild("Client"))
local doodleInfo = require(database:WaitForChild("DoodleInfo"))

-- 2. GUI SETUP
local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local StatusLabel = Instance.new("TextLabel")
local ToggleButton = Instance.new("TextButton")
local SyncButton = Instance.new("TextButton")

ScreenGui.Parent = game:GetService("CoreGui")
MainFrame.Size = UDim2.new(0, 200, 0, 200)
MainFrame.Position = UDim2.new(0.1, 0, 0.4, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

StatusLabel.Size = UDim2.new(1, 0, 0, 40)
StatusLabel.Text = "Status: Awaiting Sync"
StatusLabel.TextColor3 = Color3.new(1, 1, 1)
StatusLabel.Parent = MainFrame

getgenv().HunterEnabled = false
getgenv().CurrentArea = nil

-- 3. THE "SYNC" LOGIC (Using the Client Module you shared)
local function SyncFromGame()
    -- We pull the current chunk directly from the Client module's internal memory
    local currentChunk = client.DataManager.RegionData.ChunkName or client.DataManager.RegionData.Reference
    if currentChunk then
        getgenv().CurrentArea = currentChunk
        StatusLabel.Text = "‚úÖ Area: " .. tostring(currentChunk)
        StatusLabel.TextColor3 = Color3.new(0, 1, 0)
    else
        StatusLabel.Text = "‚ùå Stand in Grass & Click Sync"
        StatusLabel.TextColor3 = Color3.new(1, 0, 0)
    end
end

SyncButton.Size = UDim2.new(0.9, 0, 0, 40)
SyncButton.Position = UDim2.new(0.05, 0, 0.3, 0)
SyncButton.Text = "üîÑ SYNC AREA"
SyncButton.Parent = MainFrame
SyncButton.MouseButton1Click:Connect(SyncFromGame)

-- 4. THE AUTO-ENCOUNTER LOOP
task.spawn(function()
    while true do
        task.wait(1.5)
        if getgenv().HunterEnabled and getgenv().CurrentArea then
            -- Check if we are in battle using the PlayerDataFunc remote
            local battleData = player.Remotes.PlayerDataFunc:InvokeServer("GetBattleData")
            
            if not battleData or not battleData.Opponent then
                -- Trigger encounter using the synced Area name
                -- We use "WildGrass" as a fallback for the sub-area
                player.Remotes.DudeWhyld:FireServer(getgenv().CurrentArea, "WildGrass")
                StatusLabel.Text = "üì° Searching..."
            else
                local wild = battleData.Opponent
                StatusLabel.Text = "üîç Found: " .. tostring(wild.Name)
                
                -- LOGIC: Stop if 5+ Stars or Misprint
                local isRare = (wild.Stars and wild.Stars >= 5) or wild.IsMisprint or wild.IsHiddenTrait
                
                if isRare then
                    getgenv().HunterEnabled = false
                    StatusLabel.Text = "‚ú® STOPPED: RARE FOUND!"
                    ToggleButton.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
                else
                    -- Auto-Run if not rare
                    game:GetService("ReplicatedStorage").Remotes.BattleRemote:FireServer("Run")
                    repeat task.wait(0.5) until player.Remotes.PlayerDataFunc:InvokeServer("GetBattleData") == nil
                end
            end
        end
    end
end)

ToggleButton.Size = UDim2.new(0.9, 0, 0, 60)
ToggleButton.Position = UDim2.new(0.05, 0, 0.6, 0)
ToggleButton.Text = "START HUNTER"
ToggleButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
ToggleButton.Parent = MainFrame

ToggleButton.MouseButton1Click:Connect(function()
    if not getgenv().CurrentArea then
        StatusLabel.Text = "‚ùå SYNC FIRST!"
        return
    end
    getgenv().HunterEnabled = not getgenv().HunterEnabled
    ToggleButton.Text = getgenv().HunterEnabled and "STOPPING..." or "START HUNTER"
    ToggleButton.BackgroundColor3 = getgenv().HunterEnabled and Color3.fromRGB(200, 50, 50) or Color3.fromRGB(60, 60, 60)
end)
