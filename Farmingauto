-- [ INITIALIZATION ]
if not game:IsLoaded() then game.Loaded:Wait() end
local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- [ INTERNAL MODULE ACCESS ]
local Packer = Player:WaitForChild("Packer")
local Database = Packer:WaitForChild("Database")
local Client = require(Packer:WaitForChild("Client"))
local DoodleInfo = require(Database:WaitForChild("DoodleInfo"))
local Skins = require(Database:WaitForChild("Skins")).Sprites

-- [ SETTINGS ]
getgenv().Enabled = false
local Config = {
    TargetStars = 5,
    TargetTrait = "Any",
    TargetSkin = "Any",
    StopOnMisprint = true,
    AutoRun = true
}

-- [ UI CONSTRUCTION ]
local sg = Instance.new("ScreenGui", Player.PlayerGui)
sg.Name = "DoodleMasterStandalone"

local main = Instance.new("Frame", sg)
main.Size = UDim2.new(0, 300, 0, 250)
main.Position = UDim2.new(0.5, -150, 0.5, -125)
main.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
main.BorderSizePixel = 2
main.Draggable = true
main.Active = true

local title = Instance.new("TextLabel", main)
title.Size = UDim2.new(1, 0, 0, 40)
title.Text = "DOODLE AUTO-FARM V2"
title.BackgroundColor3 = Color3.fromRGB(45, 45, 60)
title.TextColor3 = Color3.new(1, 1, 1)

local status = Instance.new("TextLabel", main)
status.Size = UDim2.new(1, 0, 0, 40)
status.Position = UDim2.new(0, 0, 0.2, 0)
status.Text = "Status: Idle"
status.TextColor3 = Color3.new(0.8, 0.8, 0.8)
status.BackgroundTransparency = 1

local toggle = Instance.new("TextButton", main)
toggle.Size = UDim2.new(0.8, 0, 0, 50)
toggle.Position = UDim2.new(0.1, 0, 0.6, 0)
toggle.Text = "START HUNTING"
toggle.BackgroundColor3 = Color3.fromRGB(0, 100, 0)
toggle.TextColor3 = Color3.new(1, 1, 1)

-- [ CORE LOGIC ]
local function GetActiveChunk()
    -- Directly asks the game's DataManager for the true active chunk name
    local name = "Unknown"
    pcall(function()
        name = Client.DataManager.RegionData.ChunkName or Client.DataManager.RegionData.Reference
    end)
    return name
end

local function CheckDoodle(enemy)
    if not enemy then return false end
    
    local starMatch = (enemy.Star or 0) >= Config.TargetStars
    local misprintMatch = Config.StopOnMisprint and enemy.Shiny
    
    -- Check Skin Name if applicable
    local skinMatch = false
    if Config.TargetSkin == "Any" then
        skinMatch = true
    elseif enemy.Skin and enemy.Skin ~= 0 then
        local skinData = Skins[enemy.Name] and Skins[enemy.Name][enemy.Skin]
        if skinData and skinData.Name == Config.TargetSkin then
            skinMatch = true
        end
    end

    return starMatch or misprintMatch or skinMatch
end

toggle.MouseButton1Click:Connect(function()
    getgenv().Enabled = not getgenv().Enabled
    toggle.Text = getgenv().Enabled and "STOP" or "START HUNTING"
    toggle.BackgroundColor3 = getgenv().Enabled and Color3.fromRGB(100, 0, 0) or Color3.fromRGB(0, 100, 0)
end)

-- [ MAIN LOOP ]
task.spawn(function()
    while true do
        task.wait(1.2)
        if getgenv().Enabled then
            local currentChunk = GetActiveChunk()
            status.Text = "Area: " .. tostring(currentChunk)

            -- Check if we are already in battle
            local battleData = Player.Remotes.PlayerDataFunc:InvokeServer("GetBattleData")
            
            if not battleData then
                -- Not in battle: Trigger one
                status.Text = "üì° Triggering: " .. currentChunk
                Player.Remotes.DudeWhyld:FireServer(currentChunk, "WildGrass")
            else
                -- In battle: Check the enemy
                local enemy = battleData.Opponent
                if enemy then
                    status.Text = "‚öîÔ∏è Encounter: " .. tostring(enemy.Name)
                    
                    if CheckDoodle(enemy) then
                        getgenv().Enabled = false
                        status.Text = "‚ú® RARE FOUND! ‚ú®"
                        toggle.Text = "FINISHED"
                        -- Optional: Play a sound or notify
                    elseif Config.AutoRun then
                        -- Escape battle
                        ReplicatedStorage.Remotes.BattleRemote:FireServer("Run")
                        repeat task.wait(0.5) until Player.Remotes.PlayerDataFunc:InvokeServer("GetBattleData") == nil
                    end
                end
            end
        end
    end
end)
