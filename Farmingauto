-- // Prevent AFK Kick
for _, v in pairs(getconnections(game:GetService("Players").LocalPlayer.Idled)) do v:Disable() end

local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local Client = require(Player.Packer.Client)

-- // GLOBAL STATE
getgenv().Settings = {
    Enabled = false,
    FastForward = true,
    RebattlerFarm = false,
    AutoHeal = true,
    MinStars = 3,
    TargetDoodle = "", 
    Misprint = false
}

-- // CORE LOGIC: FAST FORWARD
task.spawn(function()
    repeat task.wait() until Client.Utilities ~= nil and Client.Utilities.Halt ~= nil
    Client.Utilities.Halt = function(ToWait)
        if getgenv().Settings.FastForward then
            local isBattle = Player.PlayerGui:FindFirstChild("MainGui") and Player.PlayerGui.MainGui.MainBattle.Visible
            if isBattle then
                task.wait(getgenv().Settings.RebattlerFarm and 0.025 or 0)
                return
            end
            if ToWait and ToWait >= 2 then task.wait(0.01) return end
        end
        task.wait(ToWait or 0.03)
    end
    Client.Camera.Zoom = function() return end 
end)

-- // BATTLE HANDLER
local function HandleBattle()
    while Client.Battle.CurrentBattle ~= nil do
        local MainGui = Player.PlayerGui:WaitForChild("MainGui")
        local BattleGui = MainGui:WaitForChild("MainBattle")
        
        repeat task.wait() until BattleGui.BottomBar.Actions.Visible or not Client.Battle.CurrentBattle
        if not Client.Battle.CurrentBattle then break end

        local Enemy = Client.Battle.CurrentBattle["Player2Party"][1]
        local MyDoodle = Client.Battle.CurrentBattle["Player1Party"][1]

        local nameMatch = (getgenv().Settings.TargetDoodle == "" or string.lower(Enemy.Name) == string.lower(getgenv().Settings.TargetDoodle))
        local starMatch = (Enemy.Star >= getgenv().Settings.MinStars)
        local misprintMatch = (not getgenv().Settings.Misprint or Enemy.Shiny)

        if nameMatch and starMatch and misprintMatch then
            getgenv().Settings.Enabled = false
            print("MATCH FOUND: " .. Enemy.Name .. " (" .. tostring(Enemy.Star) .. " Stars)")
            return 
        end

        local action = getgenv().Settings.RebattlerFarm and "Attack" or "Run"
        Client.Network:post("BattleAction", {
            [1] = {
                ["ActionType"] = action,
                ["Action"] = action == "Attack" and MyDoodle.Moves[1].Name or nil,
                ["Target"] = action == "Attack" and Enemy.ID or "RunAway",
                ["User"] = MyDoodle.ID
            }
        })
        task.wait(0.5)
    end
end

-- // BUILT-IN BIGGER MODERN GUI
local Gui = Instance.new("ScreenGui", Player.PlayerGui)
local Main = Instance.new("Frame", Gui)
Main.Size = UDim2.new(0, 350, 0, 500) -- Increased width and height
Main.Position = UDim2.new(0.3, 0, 0.2, 0)
Main.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
Main.BorderSizePixel = 2
Main.Active = true
Main.Draggable = true

local Title = Instance.new("TextLabel", Main)
Title.Size = UDim2.new(1, 0, 0, 50)
Title.Text = "Aidez Reborn: Pro Edition"
Title.TextSize = 20
Title.Font = Enum.Font.GothamBold
Title.TextColor3 = Color3.new(1,1,1)
Title.BackgroundColor3 = Color3.fromRGB(40, 40, 40)

-- Search Box
local SearchBox = Instance.new("TextBox", Main)
SearchBox.Size = UDim2.new(0.9, 0, 0, 45)
SearchBox.Position = UDim2.new(0.05, 0, 0, 65)
SearchBox.PlaceholderText = "Type Doodle Name..."
SearchBox.Text = ""
SearchBox.TextSize = 16
SearchBox.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
SearchBox.TextColor3 = Color3.new(1, 1, 1)
SearchBox:GetPropertyChangedSignal("Text"):Connect(function()
    getgenv().Settings.TargetDoodle = SearchBox.Text
end)

-- Star Control Area
local StarLabel = Instance.new("TextLabel", Main)
StarLabel.Size = UDim2.new(0.9, 0, 0, 30)
StarLabel.Position = UDim2.new(0.05, 0, 0, 115)
StarLabel.Text = "Minimum Stars: 3"
StarLabel.TextSize = 18
StarLabel.BackgroundTransparency = 1
StarLabel.TextColor3 = Color3.new(1,1,1)

local StarMinus = Instance.new("TextButton", Main)
StarMinus.Size = UDim2.new(0.43, 0, 0, 40)
StarMinus.Position = UDim2.new(0.05, 0, 0, 150)
StarMinus.Text = "- Star"
StarMinus.TextSize = 16
StarMinus.BackgroundColor3 = Color3.fromRGB(55, 55, 55)
StarMinus.TextColor3 = Color3.new(1, 1, 1)
StarMinus.MouseButton1Click:Connect(function()
    getgenv().Settings.MinStars = math.max(1, getgenv().Settings.MinStars - 1)
    StarLabel.Text = "Minimum Stars: " .. tostring(getgenv().Settings.MinStars)
end)

local StarPlus = Instance.new("TextButton", Main)
StarPlus.Size = UDim2.new(0.43, 0, 0, 40)
StarPlus.Position = UDim2.new(0.52, 0, 0, 150)
StarPlus.Text = "+ Star"
StarPlus.TextSize = 16
StarPlus.BackgroundColor3 = Color3.fromRGB(55, 55, 55)
StarPlus.TextColor3 = Color3.new(1, 1, 1)
StarPlus.MouseButton1Click:Connect(function()
    getgenv().Settings.MinStars = math.min(6, getgenv().Settings.MinStars + 1)
    StarLabel.Text = "Minimum Stars: " .. tostring(getgenv().Settings.MinStars)
end)

local function CreateToggle(text, pos, settingKey)
    local btn = Instance.new("TextButton", Main)
    btn.Size = UDim2.new(0.9, 0, 0, 45) -- Larger buttons
    btn.Position = UDim2.new(0.05, 0, 0, pos)
    btn.Text = text .. ": OFF"
    btn.TextSize = 16
    btn.Font = Enum.Font.Gotham
    btn.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    btn.TextColor3 = Color3.new(1, 1, 1)
    
    btn.MouseButton1Click:Connect(function()
        getgenv().Settings[settingKey] = not getgenv().Settings[settingKey]
        btn.Text = text .. ": " .. (getgenv().Settings[settingKey] and "ON" or "OFF")
        btn.BackgroundColor3 = getgenv().Settings[settingKey] and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(45, 45, 45)
        
        if settingKey == "Enabled" and getgenv().Settings.Enabled then
            task.spawn(function()
                while getgenv().Settings.Enabled do
                    if getgenv().Settings.AutoHeal then 
                        local Party = Client.Network:get("PlayerData", "GetParty")
                        for _, v in pairs(Party) do if v.currenthp < v.hp then Client.Network:get("Heal") break end end
                    end
                    local Grass = workspace:FindFirstChild("Grass", true) or workspace:FindFirstChild("GrassPart", true)
                    if Grass then Client.Battle.WildBattIe(nil, nil, Grass) HandleBattle() end
                    task.wait(1)
                end
                btn.Text = text .. ": OFF"
                btn.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
            end)
        end
    end)
end

-- Adjusted Y positions for the larger buttons
CreateToggle("Auto-Farm Wild", 210, "Enabled")
CreateToggle("Rebattler Farm", 265, "RebattlerFarm")
CreateToggle("Fast Forward", 320, "FastForward")
CreateToggle("Only Misprints", 375, "Misprint")
CreateToggle("Auto-Heal", 430, "AutoHeal")
