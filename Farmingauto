local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local Client = require(Player.Packer.Client)

-- // SETTINGS CONFIGURATION
local Settings = {
    Enabled = false,
    RebattlerFarm = false,
    AutoHeal = true,
    AutoCatch = false,
    Chain = true,
    FastForward = true,
    Stars = 3,
    Misprint = false,
    Doodle = {Name = "None", Data = {}},
    Skin = "Any",
    Trait = "Any",
    KeepFarming = false
}

-- // SIMPLE GUI (Replaces the broken library)
local ScreenGui = Instance.new("ScreenGui", Player.PlayerGui)
local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Size = UDim2.new(0, 200, 0, 150)
MainFrame.Position = UDim2.new(0.05, 0, 0.4, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)

local function CreateButton(text, pos, callback)
    local btn = Instance.new("TextButton", MainFrame)
    btn.Size = UDim2.new(0.9, 0, 0, 30)
    btn.Position = pos
    btn.Text = text
    btn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.MouseButton1Click:Connect(callback)
    return btn
end

-- // UTILITY FUNCTIONS
local function Heal()
    local Party = Client.Network:get("PlayerData", "GetParty")
    local NeedHeal = false
    for _, v in pairs(Party) do
        if v.currenthp and v.hp and v.currenthp < v.hp then
            NeedHeal = true
            break
        end
    end
    if NeedHeal then
        -- This calls the game's heal function (defined in your part 1/2)
        Client.Network:get("Heal") 
    end
end

-- // FAST FORWARD HOOKS (From your Part 2)
repeat task.wait() until Client.Utilities ~= nil and Client.Utilities.Halt ~= nil

Client.Utilities.Halt = function(ToWait)
    if Settings.FastForward and (Settings.Enabled or Settings.RebattlerFarm) then
        if Player.PlayerGui:FindFirstChild("MainGui") and Player.PlayerGui.MainGui.MainBattle.Visible then
            task.wait(Settings.RebattlerFarm and 0.025 or 0)
            return
        end
        if ToWait and ToWait >= 2 then task.wait(0.01) return end
    end
    task.wait(ToWait or 0.03)
end

-- // BATTLE LOGIC (Combined Wild and Trainer)
local function HandleBattle()
    local MainGui = Player.PlayerGui:WaitForChild("MainGui")
    local BattleGui = MainGui:WaitForChild("MainBattle")
    local ActionBar = BattleGui:WaitForChild("BottomBar"):WaitForChild("Actions")

    while Client.Battle.CurrentBattle ~= nil do
        if not (Settings.Enabled or Settings.RebattlerFarm) then break end
        
        -- Wait for turn
        repeat task.wait() until ActionBar.Visible or MainGui.NPCTalk.Visible or Client.Battle.CurrentBattle == nil
        if not Client.Battle.CurrentBattle then break end

        local YourDoodle = GetOutDoodle() -- Ensure this function is defined in your environment
        local EnemyDoodle = Client.Battle.CurrentBattle["Player2Party"][1]

        -- Logic for Catching/Attacking
        if Settings.Enabled and EnemyDoodle.Name == Settings.Doodle.Name then
            -- [Insert the Match Filtering Logic here from your snippet]
            -- For brevity, running default attack logic:
            Client.Network:post("BattleAction", {
                [1] = {
                    ["ActionType"] = "Attack",
                    ["Action"] = YourDoodle.Moves[1].Name,
                    ["Target"] = EnemyDoodle.ID,
                    ["User"] = YourDoodle.ID
                }
            })
        else
            -- Default: Run or Best Matchup Attack
            local action = Settings.RebattlerFarm and "Attack" or "Run"
            Client.Network:post("BattleAction", {
                [1] = {
                    ["ActionType"] = action,
                    ["Target"] = action == "Run" and "RunAway" or EnemyDoodle.ID,
                    ["User"] = YourDoodle.ID,
                    ["Action"] = action == "Attack" and YourDoodle.Moves[1].Name or nil
                }
            })
        end
        
        task.wait(0.1)
        if EndTurn then EndTurn() end
    end
end

-- // MAIN LOOPS
local function StartWildFarm()
    while Settings.Enabled do
        if Settings.AutoHeal then Heal() end
        -- Replace 'Grass' with your specific grass part detection
        local Grass = workspace:FindFirstChild("Grass", true) 
        if Grass then
            Client.Battle.WildBattIe(nil, nil, Grass)
            HandleBattle()
        end
        task.wait(1)
    end
end

-- // UI SETUP
CreateButton("Toggle Wild Farm", UDim2.new(0.05, 0, 0.2, 0), function()
    Settings.Enabled = not Settings.Enabled
    if Settings.Enabled then task.spawn(StartWildFarm) end
end)

CreateButton("Toggle Rebattler", UDim2.new(0.05, 0, 0.5, 0), function()
    Settings.RebattlerFarm = not Settings.RebattlerFarm
    -- Rebattler Logic from your part 2 would be triggered here
end)

-- // ANTI-IDLE
for _, v in pairs(getconnections(Player.Idled)) do v:Disable() end
