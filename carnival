local player = game:GetService("Players").LocalPlayer
local pGui = player:WaitForChild("PlayerGui")
local remote = player:WaitForChild("Remotes"):WaitForChild("PlayerDataFunc")

-- Your confirmed data mapping
local gameConfigs = {
    {id = "flow",      keywords = {"flow", "fishing"}, score = "S5"},
    {id = "dunk",      keywords = {"dunk"},            score = "Hards"},
    {id = "slingshot", keywords = {"slingshot"},       score = 90},
    {id = "cooking",   keywords = {"cooking"},         score = 5000},
    {id = "tys",       keywords = {"tys", "hammer"},   score = 100}
}

local function notify(title, msg)
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = title, Text = msg, Duration = 4
    })
end

-- Function to check and claim
local function tryClaim(gameId, score, displayName)
    local success = remote:InvokeServer("SendCarnivalScore", gameId, score)
    if success then
        notify("âœ… Claimed", displayName)
    end
    return success
end

-- 1. THE INITIAL SWEEP (Runs once at start)
local function initialSweep()
    notify("System Boot", "Performing initial sweep...")
    for _, gameData in ipairs(gameConfigs) do
        local status = remote:InvokeServer("GetCarnivalCooldown", gameData.id)
        
        -- Checking if ready (handling table or string)
        local ready = false
        if type(status) == "table" then
            for k, v in pairs(status) do if tostring(v):lower() == "ready" then ready = true end end
        elseif tostring(status):lower() == "ready" then
            ready = true
        end

        if ready then
            task.wait(1) -- Safety delay
            tryClaim(gameData.id, gameData.score, gameData.id)
        end
    end
    notify("Sweep Complete", "Now listening for notifications...")
end

-- 2. THE NOTIFICATION LISTENER (The "Trigger")
pGui.ChildAdded:Connect(function(child)
    task.wait(0.2) -- Let text load
    for _, obj in pairs(child:GetDescendants()) do
        if obj:IsA("TextLabel") then
            local text = obj.Text:lower()
            if text:find("ready") or text:find("available") then
                for _, gameData in ipairs(gameConfigs) do
                    for _, word in ipairs(gameData.keywords) do
                        if text:find(word) then
                            tryClaim(gameData.id, gameData.score, word)
                            return 
                        end
                    end
                end
            end
        end
    end
end)

-- Execute the sweep first
initialSweep()
