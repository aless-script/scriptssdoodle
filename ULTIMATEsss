getgenv().AutoLoop = false
local lp = game:GetService("Players").LocalPlayer
local rems = lp:WaitForChild("Remotes")
local StarterGui = game:GetService("StarterGui")

-- Remotes
local gR = rems:WaitForChild("DeliverGift")
local mR = rems:WaitForChild("SubmitWinterMinigame")
local pD = rems:WaitForChild("PlayerDataEvent")
local nS = rems:WaitForChild("GetNewSanta")
local rR = rems:WaitForChild("RedeemGift")

-- UI Detection
local mainGui = lp:WaitForChild("PlayerGui"):WaitForChild("MainGui")
local winterUI = mainGui:WaitForChild("WinterEvent")
local levelLabel = winterUI:WaitForChild("ImageLabel"):WaitForChild("Level")

-- ANTI-AFK (Fixed Method)
for i,v in pairs(getconnections(lp.Idled)) do v:Disable() end

-- GUI Setup
local sg = Instance.new("ScreenGui", lp.PlayerGui)
local main = Instance.new("TextButton", sg)
main.Size, main.Position, main.Text = UDim2.new(0, 180, 0, 60), UDim2.new(0, 30, 0.5, -30), "SAFE FARM: OFF"
main.BackgroundColor3, main.TextColor3, main.Font, main.TextSize = Color3.fromRGB(150, 30, 30), Color3.new(1, 1, 1), Enum.Font.GothamBold, 18
Instance.new("UICorner", main).CornerRadius = UDim.new(0, 8)

local function getTask()
    local taskText = "NONE"
    pcall(function()
        for _, v in pairs(winterUI:GetDescendants()) do
            if v:IsA("TextLabel") and v.Visible and v.Text ~= "" then
                local t = v.Text:upper()
                if t:find("SANTA") then taskText = "GET_TASK"
                elseif t:find("DELIVER") then 
                    if t:find("A") then taskText = "A"
                    elseif t:find("B") then taskText = "B"
                    elseif t:find("C") then taskText = "C"
                    elseif t:find("D") then taskText = "D" end
                elseif t:find("HELP") or t:find("ELF") or t:find("GAME") then taskText = "GAMES"
                end
            end
        end
    end)
    return taskText
end

-- THE BRAIN (Now strictly sequential)
task.spawn(function()
    while true do
        task.wait(1.5)
        if getgenv().AutoLoop then
            -- 1. Check for Max Level First
            if levelLabel.Text:lower():find("max") then
                rR:InvokeServer()
                task.wait(1)
                getgenv().AutoLoop = false
                main.Text = "SAFE FARM: OFF"
                main.BackgroundColor3 = Color3.fromRGB(150, 30, 30)
                continue
            end

            local state = getTask()

            if state == "GET_TASK" then
                pD:FireServer("ToggleBusy", true)
                task.wait(0.5)
                nS:InvokeServer()
                task.wait(2.5) -- IMPORTANT: Long wait for server to register new task
                pD:FireServer("ToggleBusy", false)
                task.wait(1)

            elseif state == "GAMES" then
                for _, d in ipairs({{26,"WhackAMole"},{101.66,"Matching"},{2.01,"Knitting"},{10,"Flow"}}) do
                    if not getgenv().AutoLoop then break end
                    mR:InvokeServer(d[1], d[2], 3)
                    task.wait(1.5) -- Increased delay to prevent kick
                end
                task.wait(2) -- Wait before checking for new task

            elseif state ~= "NONE" and state ~= "GET_TASK" then
                -- This handles A, B, C, D
                for num = 1, 5 do
                    if not getgenv().AutoLoop then break end
                    gR:InvokeServer(state .. num)
                    task.wait(1.5) -- Increased delay to prevent kick
                end
                task.wait(2)
            end
        end
    end
end)

-- Button Logic
main.MouseButton1Click:Connect(function()
    getgenv().AutoLoop = not getgenv().AutoLoop
    main.Text = getgenv().AutoLoop and "SAFE FARM: ON" or "SAFE FARM: OFF"
    main.BackgroundColor3 = getgenv().AutoLoop and Color3.fromRGB(0, 150, 70) or Color3.fromRGB(150, 30, 30)
end)

-- Draggable Logic
local UIS = game:GetService("UserInputService")
local dragToggle, dragInput, dragStart, startPos
main.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragToggle, dragStart, startPos = true, input.Position, main.Position
        input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragToggle = false end end)
    end
end)
UIS.InputChanged:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end end)
UIS.InputChanged:Connect(function(input) if input == dragInput and dragToggle then 
    local delta = input.Position - dragStart
    main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end end)
